<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Выручка Чи-Фань</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
h1 { color: #333; }
.container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
label { display: block; margin-top: 10px; }
input, select { margin-top: 5px; padding: 5px; }
button { margin-top: 15px; padding: 10px 15px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
button:hover { background: #218838; }
#results { margin-top: 20px; }
.progress-bar { width: 100%; background: #eee; height: 25px; border-radius: 5px; overflow: hidden; margin-top: 10px; }
.progress { height: 100%; background: #28a745; width: 0%; text-align: center; color: #fff; line-height: 25px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #28a745; color: #fff; }
</style>
</head>
<body>
<div class="container">
    <h1>Выручка Чи-Фань</h1>
    
    <label>Выберите период:
        <select id="periodType">
            <option value="day">День</option>
            <option value="week">Неделя</option>
            <option value="month">Месяц</option>
            <option value="custom">Произвольный</option>
        </select>
    </label>

    <div id="dateInputs">
        <label>Дата начала: <input type="date" id="startDate"></label>
        <label>Дата окончания: <input type="date" id="endDate"></label>
    </div>

    <button onclick="loadRevenue()">Показать выручку</button>

    <div id="results">
        <h2>Результаты</h2>
        <p>Общая выручка: <span id="totalRevenue">0</span> ₽</p>
        <p>Количество заказов: <span id="totalOrders">0</span></p>
        <p>Выполнение плана: <span id="planProgress">0%</span></p>
        <div class="progress-bar"><div class="progress" id="progressBar">0%</div></div>

        <h3>Выручка по филиалам</h3>
        <table id="venueTable">
            <thead>
                <tr>
                    <th>Филиал</th>
                    <th>Всего заказов</th>
                    <th>Выручка</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const YEAR_ROUND_VENUES = ["Красота", "Парк", "Светланская", "Чуркин", "Тихая", "Тобольская"];
const SEASONAL_VENUES = ["Юбилейный", "Кунгас", "МГУ"];

// === Генерация массива дат между start и end ===
function getDatesArray(start, end) {
    let arr = [];
    let dt = new Date(start);
    while (dt <= new Date(end)) {
        let yyyy = dt.getFullYear();
        let mm = String(dt.getMonth()+1).padStart(2,'0');
        let dd = String(dt.getDate()).padStart(2,'0');
        arr.push(`${yyyy}-${mm}-${dd}`);
        dt.setDate(dt.getDate()+1);
    }
    return arr;
}

// === Загрузка JSON файлов и суммирование ===
async function loadRevenue() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const periodType = document.getElementById("periodType").value;

    if (!startDate || !endDate) {
        alert("Выберите даты начала и окончания!");
        return;
    }

    let dates = getDatesArray(startDate, endDate);
    let totalRevenue = 0;
    let totalOrders = 0;
    let planRevenue = 0;

    let venueStats = {};

    for (const date of dates) {
        const filePath = `data/daily/${date}_revenue.json`;
        try {
            const res = await fetch(filePath);
            const data = await res.json();

            totalRevenue += data.total.total_revenue;
            totalOrders += data.total.total_orders;
            planRevenue += data.plan.total_revenue || 0;

            // Суммируем по филиалам
            const mergeStats = (src) => {
                for (const [venue, stats] of Object.entries(src)) {
                    if (!venueStats[venue]) {
                        venueStats[venue] = { total_orders: 0, total_revenue: 0 };
                    }
                    venueStats[venue].total_orders += stats.total_orders || 0;
                    venueStats[venue].total_revenue += stats.total_revenue || 0;
                }
            };
            mergeStats(data.year_round || {});
            mergeStats(data.seasonal || {});

        } catch(e) {
            console.warn(`Нет данных за ${date}`);
        }
    }

    // === Обновляем итоги ===
    document.getElementById("totalRevenue").textContent = totalRevenue.toLocaleString();
    document.getElementById("totalOrders").textContent = totalOrders;

    let progress = planRevenue ? Math.min(100, (totalRevenue / planRevenue * 100).toFixed(1)) : 0;
    document.getElementById("planProgress").textContent = progress + '%';
    document.getElementById("progressBar").style.width = progress + '%';
    document.getElementById("progressBar").textContent = progress + '%';

    // === Обновляем таблицу филиалов ===
    const tbody = document.querySelector("#venueTable tbody");
    tbody.innerHTML = "";
    for (const venue of [...YEAR_ROUND_VENUES, ...SEASONAL_VENUES]) {
        const stats = venueStats[venue] || { total_orders: 0, total_revenue: 0 };
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${venue}</td><td>${stats.total_orders}</td><td>${stats.total_revenue.toLocaleString()}</td>`;
        tbody.appendChild(tr);
    }
}

// === Авто-установка дат при смене типа периода ===
document.getElementById("periodType").addEventListener("change", function() {
    const today = new Date();
    const startInput = document.getElementById("startDate");
    const endInput = document.getElementById("endDate");

    if (this.value === "day") {
        startInput.value = today.toISOString().slice(0,10);
        endInput.value = today.toISOString().slice(0,10);
    } else if (this.value === "week") {
        let firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
        let lastDay = new Date(firstDay);
        lastDay.setDate(firstDay.getDate() + 6);
        startInput.value = firstDay.toISOString().slice(0,10);
        endInput.value = lastDay.toISOString().slice(0,10);
    } else if (this.value === "month") {
        let firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        let lastDay = new Date(today.getFullYear(), today.getMonth()+1, 0);
        startInput.value = firstDay.toISOString().slice(0,10);
        endInput.value = lastDay.toISOString().slice(0,10);
    }
});
</script>
</body>
</html>
