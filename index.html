<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чи-Фань — Аналитика выручки</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #e2e8f0; /* Более серый светлый фон */
            transition: background-color 0.3s ease;
        }
        body.theme-dark {
            background-color: #0f172a; /* Темный фон */
        }
        .card {
            background-color: #ffffff; /* Светлые карточки */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.theme-dark .card {
            background-color: #1e293b; /* Темные карточки */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--tblr-primary);
            animation: fadeInValue 1s ease;
        }
        @keyframes fadeInValue {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .metric-label {
            font-size: 0.875rem;
            color: var(--tblr-muted);
        }
        .metric-breakdown {
            font-size: 0.75rem;
            color: var(--tblr-body-color);
        }
        .orders-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .order-type {
            text-align: center;
            padding: 5px 10px;
            border-radius: 4px;
            transition: transform 0.2s ease;
        }
        .order-type:hover {
            transform: scale(1.05);
        }
        .order-type.delivery { background-color: rgba(16, 185, 129, 0.1); color: #10b981; }
        .order-type.pickup { background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .order-type.cafe { background-color: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .status-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .chart-container {
            height: 300px !important; /* Fixed height for alignment */
            animation: fadeIn 0.5s ease;
        }
        .venue-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .venue-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .row-cards .card {
            min-height: 180px; /* Выравнивание высоты */
        }
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .sales-table th, .sales-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                <i class="ti ti-chart-line me-2"></i> Чи-Фань — Аналитика выручки
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <button class="btn btn-ghost-secondary" onclick="toggleTheme()">
                                <i class="ti ti-moon"></i> Тема
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-body">
                <div class="container-xl">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="ti ti-clock me-2 text-muted"></i>
                                        <span id="last-update">Загрузка данных...</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-calendar me-2 text-muted"></i>
                                        <span id="business-day-info">Бизнес-день: <span id="business-day-date"></span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">С:</span>
                                        <input type="date" class="form-control" id="start-date">
                                        <span class="input-group-text">По:</span>
                                        <input type="date" class="form-control" id="end-date">
                                        <button class="btn btn-primary" onclick="loadCustomData()">Обновить</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-list">
                                        <button class="btn" onclick="setPeriod('today')">Сегодня</button>
                                        <button class="btn" onclick="setPeriod('yesterday')">Вчера</button>
                                        <button class="btn" onclick="setPeriod('week')">Неделя</button>
                                        <button class="btn" onclick="setPeriod('month')">Месяц</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="error-container" class="error-message mb-3" style="display: none;"></div>

                    <!-- Общая выручка и метрики -->
                    <div class="row row-cards mb-3" id="total-metrics"></div>

                    <!-- Карточки филиалов -->
                    <div class="row row-cards mb-3" id="venue-cards"></div>

                    <!-- Графики -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Выручка по филиалам</h3>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="revenue-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Заказы по филиалам</h3>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="orders-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Таблицы продаж по филиалам -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Продажи: Круглогодичные</h3>
                                </div>
                                <div class="card-body">
                                    <table class="sales-table" id="year-round-sales-table"></table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Продажи: Сезонные</h3>
                                </div>
                                <div class="card-body">
                                    <table class="sales-table" id="seasonal-sales-table"></table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Итоговые позиции (все вместе) -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title">Итоговые позиции (все филиалы вместе)</h3>
                        </div>
                        <div class="card-body">
                            <table class="sales-table" id="total-sales-table"></table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const YEAR_ROUND_VENUES = ['Красота', 'Луговая', 'Парк', 'Светланская', 'Чуркин', 'Тихая', 'Тобольская'];
        const SEASONAL_VENUES = ['Юбилейный', 'Кунгас', 'МГУ', 'Патрокл'];
        let revenueChart, ordersChart;
        let currentStartDate, currentEndDate;
        let currentFilter = 'all'; // По умолчанию 'all'

        const fmt = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' });

        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            localStorage.setItem('theme', document.body.classList.contains('theme-dark') ? 'dark' : 'light');
        }

        function getCurrentBusinessDay() {
            const now = new Date();
            now.setHours(now.getHours() - 3); // Учёт бизнес-дня
            return now;
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function setPeriod(period) {
            const today = getCurrentBusinessDay();
            let start, end;
            switch (period) {
                case 'today':
                    start = end = today;
                    break;
                case 'yesterday':
                    start = end = new Date(today);
                    start.setDate(start.getDate() - 1);
                    break;
                case 'week':
                    start = new Date(today);
                    start.setDate(start.getDate() - 6);
                    end = today;
                    break;
                case 'month':
                    start = new Date(today);
                    start.setDate(1);
                    end = today;
                    break;
            }
            document.getElementById('start-date').value = formatDateForInput(start);
            document.getElementById('end-date').value = formatDateForInput(end);
            loadCustomData();
        }

        async function load(startDate, endDate = startDate) {
            document.getElementById('last-update').textContent = 'Загрузка данных...';
            document.getElementById('error-container').style.display = 'none';
            try {
                // Для текущей даты используем revenue.json
                const data = await fetch('./data/revenue.json').then(res => {
                    if (!res.ok) throw new Error('Файл revenue.json не найден');
                    return res.json();
                });
                processData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('error-container').textContent = 'Ошибка загрузки данных: ' + error.message;
                document.getElementById('error-container').style.display = 'block';
                showToast('Ошибка загрузки данных', 'danger');
            }
        }

        async function loadCustomData() {
            currentStartDate = document.getElementById('start-date').value;
            currentEndDate = document.getElementById('end-date').value;
            if (!currentStartDate || !currentEndDate) return;

            document.getElementById('last-update').textContent = 'Загрузка данных...';
            document.getElementById('error-container').style.display = 'none';

            const dailyData = [];
            let current = new Date(currentStartDate);
            const end = new Date(currentEndDate);
            let errorMessages = [];

            while (current <= end) {
                const dateStr = formatDateForInput(current);
                try {
                    const data = await fetch(`./data/${dateStr}_data.json`).then(res => {
                        if (!res.ok) throw new Error(`Файл для ${dateStr} не найден`);
                        return res.json();
                    });
                    dailyData.push(data);
                } catch (e) {
                    errorMessages.push(e.message);
                }
                current.setDate(current.getDate() + 1);
            }

            if (dailyData.length === 0) {
                document.getElementById('error-container').textContent = 'Нет данных за выбранный период: ' + errorMessages.join(', ');
                document.getElementById('error-container').style.display = 'block';
                return;
            }

            const aggregated = aggregateData(dailyData);
            processData(aggregated);
        }

        function aggregateData(dailyData) {
            const aggregated = {
                year_round: {},
                seasonal: {},
                total: { total_orders: 0, total_revenue: 0, total_delivery_orders: 0, total_delivery_revenue: 0, total_pickup_orders: 0, total_pickup_revenue: 0, total_cafe_orders: 0, total_cafe_revenue: 0 },
                plan: { revenue: 0, orders: 0 },
                sales: {}
            };

            dailyData.forEach(data => {
                Object.entries(data.year_round || {}).forEach(([venue, stats]) => {
                    if (!aggregated.year_round[venue]) aggregated.year_round[venue] = initStats();
                    aggregateStats(aggregated.year_round[venue], stats);
                });
                Object.entries(data.seasonal || {}).forEach(([venue, stats]) => {
                    if (!aggregated.seasonal[venue]) aggregated.seasonal[venue] = initStats();
                    aggregateStats(aggregated.seasonal[venue], stats);
                });

                aggregateStats(aggregated.total, data.total || {});

                aggregated.plan.revenue += data.plan?.revenue || 0;
                aggregated.plan.orders += data.plan?.orders || 0;

                Object.entries(data.sales || {}).forEach(([venue, salesStats]) => {
                    if (!aggregated.sales[venue]) aggregated.sales[venue] = initSalesStats();
                    aggregateSales(aggregated.sales[venue], salesStats);
                });
            });

            return aggregated;
        }

        function initStats() {
            return { total_orders: 0, total_revenue: 0, delivery_orders: 0, delivery_revenue: 0, pickup_orders: 0, pickup_revenue: 0, cafe_orders: 0, cafe_revenue: 0 };
        }

        function aggregateStats(target, source) {
            Object.keys(target).forEach(key => {
                target[key] += source[key] || 0;
            });
        }

        function initSalesStats() {
            return {
                'Лапша': 0,
                'Рис': 0,
                'Курица': 0,
                'Свинина': 0,
                'Креветка': 0,
                'Бекон': 0,
                'Соломка': 0,
                'Кубик': 0,
                'Салаты - Супы': {
                    'Азиатский салат с курицей': 0,
                    'Азиатский салат с креветкой': 0,
                    'Тайский суп с курицей': 0,
                    'Тайский суп с креветкой': 0,
                    'Вьетнамский суп': 0
                },
                'Пельмени - Бао-банс': {
                    'Пельмени с курицей': 0,
                    'Бао-банс с курицей': 0
                }
            };
        }

        function aggregateSales(target, source) {
            Object.entries(source).forEach(([cat, value]) => {
                if (typeof value === 'object') {
                    Object.entries(value).forEach(([subCat, subValue]) => {
                        target[cat][subCat] += subValue || 0;
                    });
                } else {
                    target[cat] += value || 0;
                }
            });
        }

        function processData(data) {
            document.getElementById('last-update').textContent = `${data.date} ${data.time}`;
            updateTotalMetrics(data);
            updateVenueCards(data);
            updateSalesTables(data);
            updateTotalSalesTable(data);
            updateCharts(data);
        }

        function updateTotalMetrics(data) {
            const container = document.getElementById('total-metrics');
            container.innerHTML = `
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="metric-label">Выручка</div>
                            <div class="metric-value">${fmt.format(data.total.total_revenue)}</div>
                            <div class="metric-breakdown">Доставка: ${fmt.format(data.total.total_delivery_revenue)}<br>Самовывоз: ${fmt.format(data.total.total_pickup_revenue)}<br>Кафе: ${fmt.format(data.total.total_cafe_revenue)}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="metric-label">Заказы</div>
                            <div class="metric-value">${data.total.total_orders}</div>
                            <div class="orders-breakdown">
                                <div class="order-type delivery">${data.total.total_delivery_orders}</div>
                                <div class="order-type pickup">${data.total.total_pickup_orders}</div>
                                <div class="order-type cafe">${data.total.total_cafe_orders}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="metric-label">План</div>
                            <div class="metric-value">${Math.round((data.total.total_revenue / data.plan.revenue) * 100)}%</div>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-primary" style="width: ${ (data.total.total_revenue / data.plan.revenue) * 100 }%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateVenueCards(data) {
            const container = document.getElementById('venue-cards');
            container.innerHTML = '';
            const venues = { ...data.year_round, ...data.seasonal };
            const sortedVenues = Object.entries(venues).sort((a, b) => b[1].total_revenue - a[1].total_revenue);

            sortedVenues.forEach(([venue, stats]) => {
                if (stats.total_revenue > 0 || stats.total_orders > 0) {
                    container.innerHTML += `
                        <div class="col-md-4">
                            <div class="card venue-card">
                                <div class="card-header">
                                    <h3 class="card-title">${venue}</h3>
                                    <span class="status-badge bg-${stats.total_revenue > 10000 ? 'success' : 'warning'}">${fmt.format(stats.total_revenue)}</span>
                                </div>
                                <div class="card-body venue-metrics">
                                    <div>Заказы: ${stats.total_orders}</div>
                                    <div>Доставка: ${stats.delivery_orders}</div>
                                    <div>Самовывоз: ${stats.pickup_orders}</div>
                                    <div>Кафе: ${stats.cafe_orders}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function updateSalesTables(data) {
            updateSalesTable(data.year_round, data.sales, 'year-round-sales-table', YEAR_ROUND_VENUES);
            updateSalesTable(data.seasonal, data.sales, 'seasonal-sales-table', SEASONAL_VENUES);
        }

        function updateSalesTable(venuesData, salesData, tableId, venuesList) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            venuesList.forEach(venue => {
                const stats = venuesData[venue] || initStats();
                const salesStats = salesData[venue] || initSalesStats();
                if (isVenueActive(stats, salesStats)) {
                    table.innerHTML += `<tr><th colspan="2">${venue}</th></tr>`;
                    const categories = ['Лапша', 'Рис', 'Курица', 'Свинина', 'Креветка', 'Бекон', 'Соломка', 'Кубик'];
                    categories.forEach(cat => {
                        const value = salesStats[cat] || 0;
                        if (value > 0) {
                            const formattedValue = (cat === 'Соломка' || cat === 'Кубик') ? value.toFixed(2) : value.toFixed(0);
                            table.innerHTML += `<tr><td>${cat}</td><td>${formattedValue}</td></tr>`;
                        }
                    });

                    const saladSup = salesStats['Салаты - Супы'] || {};
                    if (Object.values(saladSup).some(v => v > 0)) {
                        table.innerHTML += '<tr><td colspan="2">Салаты - Супы</td></tr>';
                        const subItems = ['Азиатский салат с курицей', 'Азиатский салат с креветкой', 'Тайский суп с курицей', 'Тайский суп с креветкой', 'Вьетнамский суп'];
                        subItems.forEach(item => {
                            const value = saladSup[item] || 0;
                            if (value > 0) {
                                table.innerHTML += `<tr><td>${item}</td><td>${value}</td></tr>`;
                            }
                        });
                    }

                    const pelmeniBao = salesStats['Пельмени - Бао-банс'] || {};
                    if (Object.values(pelmeniBao).some(v => v > 0)) {
                        table.innerHTML += '<tr><td colspan="2">Пельмени - Бао-банс</td></tr>';
                        Object.entries(pelmeniBao).forEach(([item, value]) => {
                            if (value > 0) {
                                table.innerHTML += `<tr><td>${item}</td><td>${value}</td></tr>`;
                            }
                        });
                    }
                }
            });
        }

        function updateTotalSalesTable(data) {
            const table = document.getElementById('total-sales-table');
            table.innerHTML = '';
            const totalSales = initSalesStats();

            Object.values(data.sales).forEach(salesStats => {
                aggregateSales(totalSales, salesStats);
            });

            if (isSalesActive(totalSales)) {
                table.innerHTML += '<tr><th>Позиция</th><th>Количество</th></tr>';
                const categories = ['Лапша', 'Рис', 'Курица', 'Свинина', 'Креветка', 'Бекон', 'Соломка', 'Кубик'];
                categories.forEach(cat => {
                    const value = totalSales[cat] || 0;
                    if (value > 0) {
                        const formattedValue = (cat === 'Соломка' || cat === 'Кубик') ? value.toFixed(2) : value.toFixed(0);
                        table.innerHTML += `<tr><td>${cat}</td><td>${formattedValue}</td></tr>`;
                    }
                });

                const saladSup = totalSales['Салаты - Супы'] || {};
                if (Object.values(saladSup).some(v => v > 0)) {
                    table.innerHTML += '<tr><td colspan="2">Салаты - Супы</td></tr>';
                    const subItems = ['Азиатский салат с курицей', 'Азиатский салат с креветкой', 'Тайский суп с курицей', 'Тайский суп с креветкой', 'Вьетнамский суп'];
                    subItems.forEach(item => {
                        const value = saladSup[item] || 0;
                        if (value > 0) {
                            table.innerHTML += `<tr><td>${item}</td><td>${value}</td></tr>`;
                        }
                    });
                }

                const pelmeniBao = totalSales['Пельмени - Бао-банс'] || {};
                if (Object.values(pelmeniBao).some(v => v > 0)) {
                    table.innerHTML += '<tr><td colspan="2">Пельмени - Бао-банс</td></tr>';
                    Object.entries(pelmeniBao).forEach(([item, value]) => {
                        if (value > 0) {
                            table.innerHTML += `<tr><td>${item}</td><td>${value}</td></tr>`;
                        }
                    });
                }
            } else {
                table.innerHTML = '<tr><td colspan="2">Нет данных по продажам</td></tr>';
            }
        }

        function isVenueActive(stats, salesStats) {
            return stats.total_orders > 0 || isSalesActive(salesStats);
        }

        function isSalesActive(salesStats) {
            return Object.values(salesStats).some(value => {
                if (typeof value === 'object') {
                    return Object.values(value).some(v => v > 0);
                }
                return value > 0;
            });
        }

        function updateCharts(data) {
            const venues = { ...data.year_round, ...data.seasonal };
            const labels = Object.keys(venues).filter(venue => venues[venue].total_revenue > 0);
            const revenueData = labels.map(venue => venues[venue].total_revenue);
            const ordersData = labels.map(venue => venues[venue].total_orders);

            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(document.getElementById('revenue-chart'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Выручка', data: revenueData, backgroundColor: 'rgba(0, 123, 255, 0.5)' }] },
                options: { scales: { y: { beginAtZero: true } } }
            });

            if (ordersChart) ordersChart.destroy();
            ordersChart = new Chart(document.getElementById('orders-chart'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Заказы', data: ordersData, backgroundColor: 'rgba(40, 167, 69, 0.5)' }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function showToast(message, type = 'success') {
            // Простая реализация тоста
            alert(message);
        }

        function exportPDF(filter) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            doc.setFontSize(16);
            doc.text('Отчет Чи-Фань', 20, y);
            y += 10;

            doc.setFontSize(12);
            doc.text('Основные метрики:', 20, y);
            y += 10;

            const total = data.total || {};
            if (total.total_revenue > 0) doc.text(`Выручка: ${fmt.format(total.total_revenue || 0)} ₽`, 20, y); y += 7;
            if (total.total_orders > 0) doc.text(`Заказы: ${total.total_orders || 0}`, 20, y); y += 7;
            if (total.total_delivery_orders > 0) doc.text(`Доставка: ${total.total_delivery_orders || 0}`, 20, y); y += 7;
            if (total.total_pickup_orders > 0) doc.text(`Самовывоз: ${total.total_pickup_orders || 0}`, 20, y); y += 7;
            if (total.total_cafe_orders > 0) doc.text(`Кафе: ${total.total_cafe_orders || 0}`, 20, y); y += 15;

            const venues = filter === 'year-round' ? data.year_round : 
                          filter === 'seasonal' ? data.seasonal : 
                          { ...data.year_round, ...data.seasonal };
            doc.setFontSize(12);
            doc.text('Филиалы:', 20, y);
            y += 10;

            const sortedVenues = Object.entries(venues || {})
                .filter(([venue, stats]) => isVenueActive(stats, data.sales[venue]))
                .sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));

            sortedVenues.forEach(([venue, stats]) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(10);
                doc.text(`${venue}: ${fmt.format(stats.total_revenue || 0)} ₽ (${stats.total_orders || 0} заказов)`, 20, y);
                y += 7;
                if (stats.delivery_orders > 0) {
                    doc.text(`Доставка: ${stats.delivery_orders} (${fmt.format(stats.delivery_revenue || 0)} ₽)`, 25, y);
                    y += 7;
                }
                if (stats.pickup_orders > 0) {
                    doc.text(`Самовывоз: ${stats.pickup_orders} (${fmt.format(stats.pickup_revenue || 0)} ₽)`, 25, y);
                    y += 7;
                }
                if (stats.cafe_orders > 0) {
                    doc.text(`Кафе: ${stats.cafe_orders} (${fmt.format(stats.cafe_revenue || 0)} ₽)`, 25, y);
                    y += 7;
                }
            });

            if (filter === 'all' || filter === 'sales') {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(12);
                doc.text('Полуфабрикаты:', 20, y);
                y += 10;

                const allVenues = [...YEAR_ROUND_VENUES, ...SEASONAL_VENUES];
                allVenues.forEach(venue => {
                    const salesStats = data.sales[venue] || {};
                    if (isSalesActive(salesStats)) {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.setFontSize(10);
                        doc.text(`${venue}:`, 20, y);
                        y += 7;
                        const categories = ['Лапша', 'Рис', 'Курица', 'Свинина', 'Креветка', 'Бекон', 'Соломка', 'Кубик'];
                        categories.forEach(cat => {
                            const value = salesStats[cat] || 0;
                            if (value > 0) {
                                doc.text(`${cat}: ${value.toFixed(cat === 'Соломка' || cat === 'Кубик' ? 2 : 0)}`, 25, y);
                                y += 7;
                            }
                        });
                        const saladSup = salesStats['Салаты - Супы'] || {};
                        if (Object.values(saladSup).some(v => v > 0)) {
                            doc.text('Салаты - Супы:', 25, y);
                            y += 7;
                            const subItems = ['Азиатский салат с курицей', 'Азиатский салат с креветкой', 'Тайский суп с курицей', 'Тайский суп с креветкой', 'Вьетнамский суп'];
                            subItems.forEach(item => {
                                const value = saladSup[item] || 0;
                                if (value > 0) {
                                    doc.text(`${item}: ${value}`, 30, y);
                                    y += 7;
                                }
                            });
                        }
                        const pelmeniBao = salesStats['Пельмени - Бао-банс'] || {};
                        if (Object.values(pelmeniBao).some(v => v > 0)) {
                            doc.text('Пельмени - Бао-банс:', 25, y);
                            y += 7;
                            Object.entries(pelmeniBao).forEach(([item, value]) => {
                                if (value > 0) {
                                    doc.text(`${item}: ${value}`, 30, y);
                                    y += 7;
                                }
                            });
                        }
                        y += 5;
                    }
                });
            }

            doc.save(`chifan_report_${currentStartDate}_${filter}.pdf`);
            showToast('PDF успешно экспортирован');
        }

        // Инициализация
        function init() {
            // Установка темы
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('theme-dark');
            }
            
            // Установка дат по умолчанию
            const businessDay = getCurrentBusinessDay();
            const businessDayStr = formatDateForInput(businessDay);
            document.getElementById('start-date').value = businessDayStr;
            document.getElementById('end-date').value = businessDayStr;
            
            // Активная кнопка "Сегодня"
            document.querySelector('.btn-list .btn').classList.add('btn-primary');
            
            // Обновление информации о бизнес-дне
            updateBusinessDayInfo();
            
            // Загрузка данных
            load(businessDayStr, businessDayStr);
            
            // Запуск автообновления
            setupAutoRefresh();
        }

        function updateBusinessDayInfo() {
            const businessDay = getCurrentBusinessDay();
            const businessDayDate = formatDateForInput(businessDay);
            document.getElementById('business-day-date').textContent = businessDayDate;
        }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
