<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чи-Фань — Аналитика выручки</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #f0f4f8;
            transition: background-color 0.3s ease;
        }
        body.theme-dark {
            background-color: #0f172a;
        }
        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.theme-dark .card {
            background-color: #1e293b;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--tblr-primary);
            animation: fadeInValue 1s ease;
        }
        @keyframes fadeInValue {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .metric-label {
            font-size: 0.875rem;
            color: var(--tblr-muted);
        }
        .metric-breakdown {
            font-size: 0.75rem;
            color: var(--tblr-body-color);
        }
        .orders-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .order-type {
            text-align: center;
            padding: 5px 10px;
            border-radius: 4px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .order-type:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .order-type.delivery { background-color: rgba(16, 185, 129, 0.1); color: #10b981; }
        .order-type.pickup { background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .order-type.cafe { background-color: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .status-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .chart-container {
            height: auto !important;
            animation: fadeIn 0.5s ease;
        }
        .venue-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .venue-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .row-cards .card {
            min-height: 180px;
        }
        .progress-bar {
            background: linear-gradient(to right, #1a237e, #8b5cf6) !important;
        }
        body.theme-dark .ti {
            filter: invert(1);
        }
        .theme-switcher {
            transition: transform 0.3s ease;
        }
        .theme-switcher.rotated {
            transform: rotate(180deg);
        }
        @media (max-width: 768px) {
            .row-cards {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                <i class="ti ti-chart-line me-2"></i> Чи-Фань — Аналитика выручки
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <button class="btn btn-ghost-secondary theme-switcher" onclick="toggleTheme()">
                                <i class="ti ti-moon"></i> Тема
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-body">
                <div class="container-xl">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="ti ti-clock me-2 text-muted"></i>
                                        <span id="last-update">Загрузка данных...</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-calendar me-2 text-muted"></i>
                                        <span id="business-day-info">Бизнес-день: <span id="business-day-date"></span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">С:</span>
                                        <input type="date" class="form-control" id="start-date">
                                        <span class="input-group-text">По:</span>
                                        <input type="date" class="form-control" id="end-date">
                                        <button class="btn btn-primary" onclick="loadCustomData()">
                                            <i class="ti ti-download me-2"></i> Загрузить
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-list">
                                        <button class="btn" onclick="setPeriod('today', event)">Сегодня</button>
                                        <button class="btn" onclick="setPeriod('yesterday', event)">Вчера</button>
                                        <button class="btn" onclick="setPeriod('thisWeek', event)">Неделя</button>
                                        <button class="btn" onclick="setPeriod('thisMonth', event)">Месяц</button>
                                        <button class="btn" onclick="setPeriod('lastMonth', event)">Прошлый месяц</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" role="tab">Дашборд</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-analytics" role="tab">Аналитика</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane active show" id="tab-dashboard" role="tabpanel">
                            <div class="row row-cards mb-3" id="metrics"></div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-chart-line me-2"></i> Прогресс по плану</h3>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Факт: <span id="current-value">0 ₽</span></span>
                                        <span>План: <span id="plan-value">0 ₽</span></span>
                                    </div>
                                    <div class="progress progress-sm mb-2">
                                        <div id="plan-bar" class="progress-bar" style="width: 0%"></div>
                                    </div>
                                    <div id="progress-text" class="text-center">0%</div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-building me-2"></i> Круглогодичные филиалы</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row row-cards" id="year-round"></div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-leaf me-2"></i> Сезонные филиалы</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row row-cards" id="seasonal"></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-analytics" role="tabpanel">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-chart-line me-2"></i> Выручка по времени</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="timeChart" class="chart-container"></canvas>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">Выручка по филиалам</h3>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="revenueChart" class="chart-container" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">Типы заказов</h3>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="ordersChart" class="chart-container" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-list">
                        <button class="btn btn-primary" onclick="exportPDF('all')">
                            <i class="ti ti-file-text me-2"></i> Экспорт PDF (Все)
                        </button>
                        <button class="btn" onclick="exportPDF('year-round')">
                            <i class="ti ti-file-text me-2"></i> PDF Круглогодичные
                        </button>
                        <button class="btn" onclick="exportPDF('seasonal')">
                            <i class="ti ti-file-text me-2"></i> PDF Сезонные
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body"></div>
        </div>
    </div>

    <script>
        Chart.defaults.animation.duration = 1000;
        Chart.defaults.animation.easing = 'easeOutBounce';

        let revenueChart, ordersChart, timeChart;
        let currentStartDate, currentEndDate;
        let dataCache = {};
        let lastDataHash = null;
        let autoRefreshInterval = null;
        const AUTO_REFRESH_INTERVAL = 300000; // 5 минут
        const DAILY_NETWORK_PLAN = 1000000; // Пример плана
        const fixedDailyPlans = {}; // Заглушка для индивидуальных планов
        const fmt = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0 });
        const REPO_OWNER = 'wwwgolybfs-dev';
        const REPO_NAME = 'chifan2025';
        const BRANCH = 'main';

        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            const switcher = document.querySelector('.theme-switcher');
            switcher.classList.toggle('rotated');
            localStorage.setItem('theme', document.body.classList.contains('theme-dark') ? 'dark' : 'light');
            updateChartThemes();
        }

        function updateChartThemes() {
            const textColor = getComputedStyle(document.body).getPropertyValue('--tblr-body-color').trim();
            const gridColor = getComputedStyle(document.body).getPropertyValue('--tblr-border-color').trim();
            if (revenueChart) {
                revenueChart.options.scales.y.ticks.color = textColor;
                revenueChart.options.scales.x.ticks.color = textColor;
                revenueChart.options.scales.y.grid.color = gridColor;
                revenueChart.options.scales.x.grid.color = gridColor;
                revenueChart.update();
            }
            if (ordersChart) {
                ordersChart.options.plugins.legend.labels.color = textColor;
                ordersChart.options.plugins.tooltip.backgroundColor = getComputedStyle(document.body).getPropertyValue('--tblr-bg-surface').trim();
                ordersChart.options.plugins.tooltip.titleColor = textColor;
                ordersChart.options.plugins.tooltip.bodyColor = textColor;
                ordersChart.update();
            }
            if (timeChart) {
                timeChart.options.scales.y.ticks.color = textColor;
                timeChart.options.scales.x.ticks.color = textColor;
                timeChart.options.scales.y.grid.color = gridColor;
                timeChart.options.scales.x.grid.color = gridColor;
                timeChart.update();
            }
        }

        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast');
            const toastBody = toastEl.querySelector('.toast-body');
            toastBody.textContent = message;
            toastEl.classList.add('bg-' + (type === 'error' ? 'danger' : 'success'));
            const bsToast = new bootstrap.Toast(toastEl);
            bsToast.show();
        }

        function getTodayDateString() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        function getCurrentBusinessDay() {
            const now = new Date();
            if (now.getHours() < 3) {
                now.setDate(now.getDate() - 1);
            }
            return now;
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function setPeriod(period, event) {
            const today = new Date();
            let start, end;
            
            switch(period) {
                case 'today':
                    start = end = getCurrentBusinessDay();
                    break;
                case 'yesterday':
                    start = end = new Date(today.setDate(today.getDate() - 1));
                    break;
                case 'thisWeek':
                    start = new Date(today.setDate(today.getDate() - today.getDay() + 1));
                    end = new Date();
                    break;
                case 'thisMonth':
                    start = new Date(today.getFullYear(), today.getMonth(), 1); // С 1-го числа текущего месяца
                    end = new Date(); // До текущей даты
                    break;
                case 'lastMonth':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1); // С 1-го числа прошлого месяца
                    end = new Date(today.getFullYear(), today.getMonth(), 0); // До последнего числа прошлого месяца
                    break;
            }
            
            const startStr = formatDateForInput(start);
            const endStr = formatDateForInput(end);
            
            document.getElementById('start-date').value = startStr;
            document.getElementById('end-date').value = endStr;
            
            event.target.parentNode.querySelectorAll('.btn').forEach(btn => btn.classList.remove('btn-primary'));
            event.target.classList.add('btn-primary');
            
            load(startStr, endStr);
        }

        function getDatesBetween(startDate, endDate) {
            let dates = [];
            let current = new Date(startDate);
            const end = new Date(endDate);
            while (current <= end) {
                dates.push(current.toISOString().split('T')[0]);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Failed with status ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                }
            }
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function aggregateData(dailyDataArray) {
            const aggregated = {
                year_round: {},
                seasonal: {},
                total: { 
                    total_orders: 0, 
                    total_revenue: 0, 
                    total_delivery_orders: 0,
                    total_delivery_revenue: 0,
                    total_pickup_orders: 0,
                    total_pickup_revenue: 0,
                    total_cafe_orders: 0,
                    total_cafe_revenue: 0
                },
                plan: { total_revenue: 0, total_orders: 0 },
                date: dailyDataArray[0]?.date || '',
                time: dailyDataArray[dailyDataArray.length - 1]?.time || ''
            };

            const monthlyPlans = {};
            const monthDaysInPeriod = {};

            dailyDataArray.forEach(dayData => {
                if (dayData) {
                    const month = dayData.date.substring(0, 7);
                    if (!monthlyPlans[month]) {
                        monthlyPlans[month] = {
                            planRevenue: dayData.plan.total_revenue || 0,
                            planOrders: dayData.plan.total_orders || 0,
                            daysInMonth: getDaysInMonth(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]) - 1)
                        };
                    }
                    monthDaysInPeriod[month] = (monthDaysInPeriod[month] || 0) + 1;

                    ['year_round', 'seasonal'].forEach(section => {
                        Object.entries(dayData[section] || {}).forEach(([venue, stats]) => {
                            if (!aggregated[section][venue]) {
                                aggregated[section][venue] = { 
                                    total_revenue: 0, 
                                    total_orders: 0, 
                                    delivery_orders: 0, 
                                    pickup_orders: 0, 
                                    cafe_orders: 0, 
                                    delivery_revenue: 0, 
                                    pickup_revenue: 0, 
                                    cafe_revenue: 0 
                                };
                            }
                            Object.keys(stats).forEach(key => {
                                aggregated[section][venue][key] += stats[key] || 0;
                            });
                        });
                    });

                    aggregated.total.total_orders += dayData.total.total_orders || 0;
                    aggregated.total.total_revenue += dayData.total.total_revenue || 0;
                    aggregated.total.total_delivery_orders += dayData.total.total_delivery_orders || 0;
                    aggregated.total.total_delivery_revenue += dayData.total.total_delivery_revenue || 0;
                    aggregated.total.total_pickup_orders += dayData.total.total_pickup_orders || 0;
                    aggregated.total.total_pickup_revenue += dayData.total.total_pickup_revenue || 0;
                    aggregated.total.total_cafe_orders += dayData.total.total_cafe_orders || 0;
                    aggregated.total.total_cafe_revenue += dayData.total.total_cafe_revenue || 0;
                }
            });

            // Пропорциональный план
            Object.keys(monthlyPlans).forEach(month => {
                const daysInPeriod = monthDaysInPeriod[month] || 0;
                const plan = monthlyPlans[month];
                aggregated.plan.total_revenue += (plan.planRevenue / plan.daysInMonth) * daysInPeriod;
                aggregated.plan.total_orders += (plan.planOrders / plan.daysInMonth) * daysInPeriod;
            });

            // Агрегация breakdown
            const allVenues = { ...aggregated.year_round, ...aggregated.seasonal };
            aggregated.total.total_delivery_orders = Object.values(allVenues).reduce((sum, v) => sum + (v.delivery_orders || 0), 0);
            aggregated.total.total_pickup_orders = Object.values(allVenues).reduce((sum, v) => sum + (v.pickup_orders || 0), 0);
            aggregated.total.total_cafe_orders = Object.values(allVenues).reduce((sum, v) => sum + (v.cafe_orders || 0), 0);
            aggregated.total.total_delivery_revenue = Object.values(allVenues).reduce((sum, v) => sum + (v.delivery_revenue || 0), 0);
            aggregated.total.total_pickup_revenue = Object.values(allVenues).reduce((sum, v) => sum + (v.pickup_revenue || 0), 0);
            aggregated.total.total_cafe_revenue = Object.values(allVenues).reduce((sum, v) => sum + (v.cafe_revenue || 0), 0);

            return aggregated;
        }

        async function loadData(startDate, endDate) {
            const cacheKey = `${startDate}-${endDate}`;
            if (dataCache[cacheKey]) return dataCache[cacheKey];

            try {
                const dates = getDatesBetween(startDate, endDate);
                const dailyData = await Promise.all(dates.map(async date => {
                    if (dataCache[date]) return dataCache[date];
                    const path = date === getTodayDateString() ? 'data/revenue.json' : `data/daily/${date}_revenue.json`;
                    const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${path}`;
                    try {
                        const data = await fetchWithRetry(url);
                        dataCache[date] = data;
                        return data;
                    } catch {
                        return null;
                    }
                }));

                const validData = dailyData.filter(d => d !== null);
                if (validData.length === 0) throw new Error('Нет данных для выбранного периода');

                const aggregated = aggregateData(validData);
                dataCache[cacheKey] = aggregated;
                return aggregated;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                throw error;
            }
        }

        function getDiffDays(start, end) {
            return Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
        }

        function getStatusClass(percentage) {
            if (percentage >= 100) return 'success';
            if (percentage >= 80) return 'warning';
            return 'danger';
        }

        function renderMetrics(data) {
            const total = data.total || {};
            const plan = data.plan || {};
            const revenuePercentage = plan.total_revenue > 0 ? (total.total_revenue / plan.total_revenue) * 100 : 0;
            const avgBillTotal = total.total_orders > 0 ? total.total_revenue / total.total_orders : 0;

            document.getElementById('metrics').innerHTML = `
                <div class="col-md-3">
                    <div class="card fade-in">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-currency-ruble text-primary me-2"></i>
                                <h3 class="card-title mb-0">Выручка</h3>
                            </div>
                            <div class="metric-value">${fmt.format(total.total_revenue || 0)} ₽</div>
                            <div class="orders-breakdown">
                                <div class="order-type delivery"><i class="ti ti-truck me-1"></i>Доставка: ${fmt.format(total.total_delivery_revenue || 0)} ₽</div>
                                <div class="order-type pickup"><i class="ti ti-walk me-1"></i>Самовывоз: ${fmt.format(total.total_pickup_revenue || 0)} ₽</div>
                                <div class="order-type cafe"><i class="ti ti-coffee me-1"></i>Кафе: ${fmt.format(total.total_cafe_revenue || 0)} ₽</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card fade-in">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-shopping-cart text-primary me-2"></i>
                                <h3 class="card-title mb-0">Заказы</h3>
                            </div>
                            <div class="metric-value">${total.total_orders || 0}</div>
                            <div class="orders-breakdown">
                                <div class="order-type delivery"><i class="ti ti-truck me-1"></i>Доставка: ${total.total_delivery_orders || 0}</div>
                                <div class="order-type pickup"><i class="ti ti-walk me-1"></i>Самовывоз: ${total.total_pickup_orders || 0}</div>
                                <div class="order-type cafe"><i class="ti ti-coffee me-1"></i>Кафе: ${total.total_cafe_orders || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card fade-in">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-receipt text-primary me-2"></i>
                                <h3 class="card-title mb-0">Средний чек</h3>
                            </div>
                            <div class="metric-value">${fmt.format(avgBillTotal || 0)} ₽</div>
                            <div class="metric-breakdown">
                                Доставка: ${fmt.format(total.total_delivery_orders > 0 ? (total.total_delivery_revenue / total.total_delivery_orders) : 0)} ₽
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card fade-in">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-percentage text-primary me-2"></i>
                                <h3 class="card-title mb-0">Выполнение плана</h3>
                            </div>
                            <div class="metric-value text-${getStatusClass(revenuePercentage)}">${revenuePercentage.toFixed(1)}%</div>
                            <div class="metric-breakdown">
                                План: ${fmt.format(plan.total_revenue || 0)} ₽
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const bar = document.getElementById('plan-bar');
            const progressText = document.getElementById('progress-text');
            const currentValue = document.getElementById('current-value');
            const planValue = document.getElementById('plan-value');

            if (bar && progressText && currentValue && planValue) {
                bar.classList.add('bg-' + getStatusClass(revenuePercentage));
                bar.style.width = `${Math.min(revenuePercentage, 100)}%`;
                progressText.textContent = `${revenuePercentage.toFixed(1)}%`;
                currentValue.textContent = `${fmt.format(total.total_revenue || 0)} ₽`;
                planValue.textContent = `${fmt.format(plan.total_revenue || 0)} ₽`;
            }

            if (revenuePercentage >= 100) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        function renderVenueCard(venue, stats, periodDays) {
            const dailyPlan = fixedDailyPlans[venue] || DAILY_NETWORK_PLAN;
            const planRevenueForPeriod = dailyPlan * periodDays;
            const percentage = planRevenueForPeriod > 0 ? (stats.total_revenue / planRevenueForPeriod * 100) : 0;
            const status = getStatusClass(percentage);
            const avgCheck = stats.total_orders > 0 ? stats.total_revenue / stats.total_orders : 0;

            return `
                <div class="col-md-4">
                    <div class="card venue-card fade-in">
                        <div class="card-header">
                            <h3 class="card-title mb-0">${venue}</h3>
                            <span class="badge bg-${status} ms-2">${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="card-body">
                            <div class="progress progress-xs mb-3">
                                <div class="progress-bar bg-${status}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div class="venue-metrics">
                                <div><small class="text-muted">Выручка</small><div>${fmt.format(stats.total_revenue || 0)} ₽</div></div>
                                <div><small class="text-muted">Заказы</small><div>${stats.total_orders || 0}</div></div>
                                <div><small class="text-muted">Средний чек</small><div>${fmt.format(avgCheck || 0)} ₽</div></div>
                                <div><small class="text-muted">План</small><div>Нет данных (обновите backend)</div></div>
                            </div>
                            <div class="orders-breakdown mt-3">
                                <div class="order-type delivery"><i class="ti ti-truck me-1"></i>Доставка: ${stats.delivery_orders || 0}</div>
                                <div class="order-type pickup"><i class="ti ti-walk me-1"></i>Самовывоз: ${stats.pickup_orders || 0}</div>
                                <div class="order-type cafe"><i class="ti ti-coffee me-1"></i>Кафе: ${stats.cafe_orders || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVenues(data, containerId) {
            const key = containerId === 'year-round' ? 'year_round' : 'seasonal';
            const venues = data[key] || {};
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            if (Object.keys(venues).length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Нет данных по филиалам</div>';
                return;
            }
            
            const periodDays = getDiffDays(currentStartDate, currentEndDate);
            const sortedVenues = Object.entries(venues)
                .sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            
            container.innerHTML = sortedVenues.map(([venue, stats]) => renderVenueCard(venue, stats, periodDays)).join('');
        }

        async function renderTimeChart(startDate, endDate) {
            const ctxTime = document.getElementById('timeChart')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--tblr-body-color').trim();
            const gridColor = getComputedStyle(document.body).getPropertyValue('--tblr-border-color').trim();

            if (ctxTime && timeChart) {
                timeChart.destroy();
            }

            const dates = getDatesBetween(startDate, endDate);
            const dailyData = await Promise.all(dates.map(async date => {
                const path = date === getTodayDateString() ? 'data/revenue.json' : `data/daily/${date}_revenue.json`;
                const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${path}`;
                try {
                    return await fetchWithRetry(url);
                } catch {
                    return null;
                }
            }));

            const validData = dailyData.filter(d => d !== null);
            const days = getDiffDays(startDate, endDate);
            let labels = [];
            let revenueData = [];
            let deliveryData = [];
            let pickupData = [];
            let cafeData = [];
            let type = 'line';
            let timeUnit = 'day';

            if (days > 31) {
                type = 'bar';
                timeUnit = 'month';
                const monthlyData = { revenue: {}, delivery: {}, pickup: {}, cafe: {} };
                validData.forEach(dayData => {
                    if (dayData) {
                        const month = dayData.date.substring(0, 7);
                        monthlyData.revenue[month] = (monthlyData.revenue[month] || 0) + (dayData.total.total_revenue || 0);
                        monthlyData.delivery[month] = (monthlyData.delivery[month] || 0) + (dayData.total.total_delivery_revenue || 0);
                        monthlyData.pickup[month] = (monthlyData.pickup[month] || 0) + (dayData.total.total_pickup_revenue || 0);
                        monthlyData.cafe[month] = (monthlyData.cafe[month] || 0) + (dayData.total.total_cafe_revenue || 0);
                    }
                });
                labels = Object.keys(monthlyData.revenue).sort();
                revenueData = labels.map(month => monthlyData.revenue[month] || 0);
                deliveryData = labels.map(month => monthlyData.delivery[month] || 0);
                pickupData = labels.map(month => monthlyData.pickup[month] || 0);
                cafeData = labels.map(month => monthlyData.cafe[month] || 0);
            } else {
                labels = dates;
                revenueData = dailyData.map(day => day ? (day.total.total_revenue || 0) : 0);
                deliveryData = dailyData.map(day => day ? (day.total.total_delivery_revenue || 0) : 0);
                pickupData = dailyData.map(day => day ? (day.total.total_pickup_revenue || 0) : 0);
                cafeData = dailyData.map(day => day ? (day.total.total_cafe_revenue || 0) : 0);
            }

            if (ctxTime) {
                timeChart = new Chart(ctxTime, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Выручка (₽)',
                                data: revenueData,
                                backgroundColor: 'var(--tblr-primary)',
                                borderColor: 'var(--tblr-primary)',
                                borderWidth: 2,
                                fill: true
                            },
                            {
                                label: 'Доставка',
                                data: deliveryData,
                                backgroundColor: '#10b981',
                                borderColor: '#10b981',
                                borderWidth: 2,
                                fill: true
                            },
                            {
                                label: 'Самовывоз',
                                data: pickupData,
                                backgroundColor: '#f59e0b',
                                borderColor: '#f59e0b',
                                borderWidth: 2,
                                fill: true
                            },
                            {
                                label: 'Кафе',
                                data: cafeData,
                                backgroundColor: '#8b5cf6',
                                borderColor: '#8b5cf6',
                                borderWidth: 2,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${fmt.format(context.raw)} ₽`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return fmt.format(value) + ' ₽';
                                    },
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            },
                            x: {
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            }
                        }
                    }
                });
            }
        }

        function getColor(index) {
            const colors = ['#1a237e', '#283593', '#303f9f', '#3949ab', '#3f51b5', '#5c6bc0', '#7986cb', '#9fa8da', '#b39ddb', '#c7a4ff'];
            return colors[index % colors.length];
        }

        function renderCharts(data) {
            const allVenues = { ...data.year_round, ...data.seasonal };
            const labels = Object.keys(allVenues);
            const revenues = labels.map(venue => allVenues[venue]?.total_revenue || 0);
            
            const ctxRevenue = document.getElementById('revenueChart')?.getContext('2d');
            const ctxOrders = document.getElementById('ordersChart')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--tblr-body-color').trim();
            const gridColor = getComputedStyle(document.body).getPropertyValue('--tblr-border-color').trim();
            
            if (ctxRevenue && revenueChart) {
                revenueChart.destroy();
            }
            
            if (ctxRevenue) {
                revenueChart = new Chart(ctxRevenue, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Выручка (₽)',
                            data: revenues,
                            backgroundColor: labels.map((_, i) => getColor(i)),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Выручка: ${fmt.format(context.raw)} ₽`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return fmt.format(value) + ' ₽';
                                    },
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            },
                            x: {
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            }
                        }
                    }
                });
            }
            
            const orderTypes = {
                'Доставка': data.total.total_delivery_orders || 0,
                'Самовывоз': data.total.total_pickup_orders || 0,
                'Кафе': data.total.total_cafe_orders || 0
            };
            
            if (ctxOrders && ordersChart) {
                ordersChart.destroy();
            }
            
            if (ctxOrders) {
                ordersChart = new Chart(ctxOrders, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(orderTypes),
                        datasets: [{
                            data: Object.values(orderTypes),
                            backgroundColor: ['#10b981', '#f59e0b', '#8b5cf6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: textColor,
                                    padding: 10,
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            }
            
            updateChartThemes();
        }

        function loadCustomData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showToast('Выберите начальную и конечную дату', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showToast('Начальная дата не может быть позже конечной', 'error');
                return;
            }
            
            const periodText = startDate === endDate ? 
                `за ${new Date(startDate).toLocaleDateString('ru-RU')}` :
                `с ${new Date(startDate).toLocaleDateString('ru-RU')} по ${new Date(endDate).toLocaleDateString('ru-RU')}`;
            
            showToast(`Загрузка данных ${periodText}`);
            load(startDate, endDate);
        }

        async function load(startDateStr, endDateStr) {
            const updateEl = document.getElementById('last-update');
            if (updateEl) {
                updateEl.innerHTML = '<i class="ti ti-refresh ti-spin"></i> Загрузка...';
            }
            
            currentStartDate = startDateStr;
            currentEndDate = endDateStr;
            
            const businessDay = getCurrentBusinessDay();
            const todayStr = formatDateForInput(businessDay);
            
            if (startDateStr === todayStr || endDateStr === todayStr) {
                delete dataCache[todayStr];
            }
            
            try {
                const data = await loadData(startDateStr, endDateStr);
                if (!data) {
                    throw new Error('Данные не получены');
                }
                dataCache.current = data;
                
                const currentDataHash = JSON.stringify(data.total);
                if (lastDataHash && lastDataHash !== currentDataHash) {
                    showToast('Обновлены данные', 'success');
                }
                lastDataHash = currentDataHash;
                
                let dateDisplay = startDateStr === endDateStr ? 
                    new Date(startDateStr).toLocaleDateString('ru-RU') :
                    `${new Date(startDateStr).toLocaleDateString('ru-RU')} - ${new Date(endDateStr).toLocaleDateString('ru-RU')}`;
                
                if (updateEl) {
                    updateEl.innerHTML = `<i class="ti ti-check"></i> Обновлено: ${data.time} (${dateDisplay})`;
                }
                
                renderMetrics(data);
                renderVenues(data, 'year-round');
                renderVenues(data, 'seasonal');
                renderCharts(data);
                await renderTimeChart(currentStartDate, currentEndDate);
                
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                if (updateEl) {
                    updateEl.innerHTML = '<i class="ti ti-alert-triangle"></i> Ошибка загрузки';
                }
                
                document.getElementById('metrics').innerHTML = '<div class="alert alert-danger">Ошибка загрузки метрик: ' + error.message + '</div>';
                document.getElementById('year-round').innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных по круглогодичным филиалам</div>';
                document.getElementById('seasonal').innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных по сезонным филиалам</div>';
                
                showToast('Ошибка загрузки данных: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    document.querySelectorAll('.card').forEach((el, index) => {
                        setTimeout(() => el.classList.add('fade-in'), index * 50);
                    });
                }, 100);
            }
        }

        async function exportPDF(filter = 'all') {
            const data = dataCache.current;
            if (!data) {
                showToast('Нет данных для экспорта', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Чи-Фань - Отчет по выручке', 20, 20);
            
            doc.setFontSize(10);
            doc.text(`Период: ${currentStartDate} - ${currentEndDate}`, 20, 30);
            doc.text(`Время обновления: ${data.time}`, 20, 35);
            
            let y = 45;
            
            doc.setFontSize(12);
            doc.text('Основные метрики:', 20, y);
            y += 10;
            
            const total = data.total || {};
            doc.text(`Выручка: ${fmt.format(total.total_revenue || 0)} ₽`, 20, y);
            y += 7;
            doc.text(`Заказы: ${total.total_orders || 0}`, 20, y);
            y += 7;
            doc.text(`Доставка: ${total.total_delivery_orders || 0}`, 20, y);
            y += 7;
            doc.text(`Самовывоз: ${total.total_pickup_orders || 0}`, 20, y);
            y += 7;
            doc.text(`Кафе: ${total.total_cafe_orders || 0}`, 20, y);
            y += 15;
            
            const venues = filter === 'year-round' ? data.year_round : 
                          filter === 'seasonal' ? data.seasonal : 
                          { ...data.year_round, ...data.seasonal };
            
            doc.setFontSize(12);
            doc.text('Филиалы:', 20, y);
            y += 10;
            
            const sortedVenues = Object.entries(venues || {})
                .sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            
            sortedVenues.forEach(([venue, stats]) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(10);
                doc.text(`${venue}: ${fmt.format(stats.total_revenue || 0)} ₽ (${stats.total_orders || 0} заказов)`, 20, y);
                y += 7;
            });
            
            const canvas = document.getElementById('revenueChart');
            if (canvas) {
                try {
                    const imgData = await html2canvas(canvas).then(canvas => canvas.toDataURL('image/png'));
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, 10, 190, 100);
                } catch (e) {
                    console.error('Ошибка экспорта чарта:', e);
                }
            }

            doc.save(`chifan_report_${currentStartDate}_${filter}.pdf`);
            showToast('PDF успешно экспортирован');
        }

        function init() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('theme-dark');
                document.querySelector('.theme-switcher').classList.add('rotated');
            }
            
            const businessDay = getCurrentBusinessDay();
            const businessDayStr = formatDateForInput(businessDay);
            document.getElementById('start-date').value = businessDayStr;
            document.getElementById('end-date').value = businessDayStr;
            
            document.querySelector('.btn-list .btn').classList.add('btn-primary');
            
            updateBusinessDayInfo();
            
            load(businessDayStr, businessDayStr);
            
            setupAutoRefresh();
        }

        function updateBusinessDayInfo() {
            const businessDay = getCurrentBusinessDay();
            const businessDayDate = formatDateForInput(businessDay);
            document.getElementById('business-day-date').textContent = businessDayDate;
        }

        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                const businessDay = getCurrentBusinessDay();
                const todayStr = formatDateForInput(businessDay);
                
                if (currentStartDate === todayStr && currentEndDate === todayStr) {
                    console.log('Автообновление данных...');
                    delete dataCache[todayStr];
                    load(currentStartDate, currentEndDate);
                }
            }, AUTO_REFRESH_INTERVAL);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
