<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chi-Fan ‚Äî –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f9fafb;
      --text: #1e1e1e;
      --card: #fff;
      --accent: #f44336;
      --border: #ddd;
      --good: #43a047;
      --warn: #ffa000;
    }
    body.dark {
      --bg: #121212;
      --text: #e0e0e0;
      --card: #1e1e1e;
      --accent: #ff5252;
      --border: #333;
      --good: #81c784;
      --warn: #ffd54f;
    }
    * {
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }
    body {
      font-family: "Inter", sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }
    header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      font-size: 1.3rem;
      margin: 0;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    select, button {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.4rem 0.6rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    select:hover, button:hover {
      border-color: var(--accent);
    }
    main {
      padding: 1.5rem;
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      transition: transform .2s;
    }
    .card:hover {
      transform: translateY(-2px);
    }
    h2 {
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 0.6rem;
    }
    #last-update {
      font-size: 0.9rem;
      opacity: 0.75;
      margin-top: 0.4rem;
    }
    .metrics-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
    }
    .metric {
      flex: 1;
      min-width: 120px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.6rem;
      text-align: center;
    }
    .metric h3 {
      font-size: 1rem;
      margin: 0.2rem 0;
    }
    .metric span {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .venue-item {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px dashed var(--border);
      font-size: 0.9rem;
    }
    .venue-item:last-child { border-bottom: none; }
    .venue-revenue { font-weight: 600; }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 100;
    }
  </style>
</head>
<body>
  <header>
    <h1>üçú Chi-Fan ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç</h1>
    <div class="controls">
      <select id="dateSelector">
        <option>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç...</option>
      </select>
      <button id="themeBtn" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      <div class="metrics-grid" id="metrics"></div>
      <div id="last-update"></div>
    </div>

    <div class="card">
      <h2>–§–∏–ª–∏–∞–ª—ã (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ)</h2>
      <div id="venues-year-round">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="card">
      <h2>–§–∏–ª–∏–∞–ª—ã (—Å–µ–∑–æ–Ω–Ω—ã–µ)</h2>
      <div id="venues-seasonal">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="card">
      <h2>–í—ã—Ä—É—á–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      <canvas id="chartRevenue" height="180"></canvas>
    </div>

    <div class="card">
      <h2>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      <canvas id="chartCheck" height="180"></canvas>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const fmt = new Intl.NumberFormat('ru-RU');
    const REPO_API = 'https://api.github.com/repos/wwwgolybfs-dev/chifan2025/contents/data/daily';
    const RAW_DAILY = 'https://raw.githubusercontent.com/wwwgolybfs-dev/chifan2025/main/data/daily/';
    const RAW_TODAY = 'https://raw.githubusercontent.com/wwwgolybfs-dev/chifan2025/main/data/revenue.json';
    let chartRevenue, chartCheck;

    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      document.getElementById('themeBtn').innerHTML = document.body.classList.contains('dark')
        ? '<i class="fas fa-sun"></i>'
        : '<i class="fas fa-moon"></i>';
    }

    function showToast(text) {
      const t = document.getElementById('toast');
      t.textContent = text;
      t.style.opacity = '1';
      setTimeout(() => (t.style.opacity = '0'), 3000);
    }

    async function listAvailableFiles() {
      const res = await fetch(REPO_API);
      const files = await res.json();
      return files
        .filter(f => f.name.endsWith('_revenue.json'))
        .sort((a,b) => new Date(b.name.split('_')[0]) - new Date(a.name.split('_')[0]))
        .map(f => f.name);
    }

    async function fetchData(file) {
      const url = file === 'today' ? RAW_TODAY : RAW_DAILY + file;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${url}`);
      return await res.json();
    }

    async function initDateSelector() {
      const selector = document.getElementById('dateSelector');
      selector.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
      try {
        const files = await listAvailableFiles();
        let options = `<option value="today">–°–µ–≥–æ–¥–Ω—è</option>`;
        options += files.map(f => `<option value="${f}">${f.replace('_revenue.json','')}</option>`).join('');
        selector.innerHTML = options;

        const saved = localStorage.getItem('selectedDate');
        selector.value = saved && [...selector.options].some(o=>o.value===saved) ? saved : 'today';

        selector.onchange = () => {
          localStorage.setItem('selectedDate', selector.value);
          loadData(selector.value);
        };

        await loadData(selector.value);
      } catch (err) {
        console.error(err);
        selector.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç</option>';
      }
    }

    async function loadData(file) {
      const last = document.getElementById('last-update');
      last.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
      try {
        const data = await fetchData(file);
        renderMetrics(data);
        renderVenues(data, 'year-round');
        renderVenues(data, 'seasonal');
        renderCharts(data);
        last.innerHTML = `<i class="fas fa-check-circle"></i> –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${data.date || file}`;
        showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      } catch (err) {
        console.error(err);
        last.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      }
    }

    function renderMetrics(data) {
      const el = document.getElementById('metrics');
      if (!data.metrics) {
        el.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        return;
      }
      el.innerHTML = `
        <div class="metric">
          <span>üí∞ –í—ã—Ä—É—á–∫–∞</span>
          <h3>${fmt.format(data.metrics.total_revenue || 0)} ‚ÇΩ</h3>
        </div>
        <div class="metric">
          <span>üßæ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</span>
          <h3>${fmt.format(data.metrics.avg_check || 0)} ‚ÇΩ</h3>
        </div>
        <div class="metric">
          <span>üç± –ó–∞–∫–∞–∑—ã</span>
          <h3>${fmt.format(data.metrics.orders || 0)}</h3>
        </div>
      `;
    }

    function renderVenues(data, type) {
      const el = document.getElementById('venues-' + type);
      const venues = (data.venues || []).filter(v => v.type === type);
      if (!venues.length) {
        el.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        return;
      }
      el.innerHTML = venues
        .map(v => `
          <div class="venue-item">
            <span>${v.name}</span>
            <span class="venue-revenue">${fmt.format(v.revenue)} ‚ÇΩ</span>
          </div>`)
        .join('');
    }

    function renderCharts(data) {
      const venues = data.venues || [];
      const labels = venues.map(v => v.name);
      const revenues = venues.map(v => v.revenue);
      const checks = venues.map(v => v.avg_check);
      const ctxR = document.getElementById('chartRevenue');
      const ctxC = document.getElementById('chartCheck');
      if (chartRevenue) chartRevenue.destroy();
      if (chartCheck) chartCheck.destroy();
      chartRevenue = new Chart(ctxR, {
        type: 'bar',
        data: { labels, datasets: [{ label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)', data: revenues, backgroundColor: '#f44336aa' }] },
        options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'var(--text)' } }, y: { ticks: { color: 'var(--text)' } } } }
      });
      chartCheck = new Chart(ctxC, {
        type: 'bar',
        data: { labels, datasets: [{ label: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)', data: checks, backgroundColor: '#43a047aa' }] },
        options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'var(--text)' } }, y: { ticks: { color: 'var(--text)' } } } }
      });
    }

    initDateSelector();
    setInterval(() => {
      const sel = document.getElementById('dateSelector');
      if (sel && sel.value) loadData(sel.value);
    }, 5 * 60 * 1000);
  </script>
</body>
</html>
