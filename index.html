
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чи-Фань — Выручка и Аналитика в реальном времени</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem; /* Размер из первого варианта */
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .theme-toggle:hover {
            background: #2563eb;
        }

        #last-update {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        /* Стили для элементов управления датами из второго варианта */
        .period-selector, input[type="date"] {
            padding: 6px 10px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .data-selector { /* Стиль для селектора данных в графике */
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .export-btn, .action-btn { /* Объединение стилей кнопок */
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover, .action-btn:hover {
            background: #059669;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Чуть шире, как в первом */
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideIn 0.5s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .metric-card.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .metric-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Прогресс-бар */
        .progress-container {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease; /* Уменьшаем время для более быстрого обновления */
            border-radius: 10px;
        }

        .progress-fill.good { background: linear-gradient(90deg, var(--success-color), #059669); }
        .progress-fill.warn { background: linear-gradient(90deg, var(--warning-color), #d97706); }
        .progress-fill.bad { background: linear-gradient(90deg, var(--danger-color), #dc2626); }

        .progress-text {
            text-align: center;
            font-weight: 500;
            margin-top: 10px;
        }

        /* Секции и карточки филиалов */
        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .venues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Размер из первого варианта */
            gap: 20px;
        }

        .venue-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
            cursor: pointer;
        }

        .venue-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .venue-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .venue-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .venue-metric-value {
            font-weight: 500;
        }
        
        /* Графики */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Из первого варианта (2 колонки) */
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        /* Дополнительные стили из второго варианта для header-left и controls */
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .period-controls {
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 10px;
        }

        .date-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .date-inputs label {
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .venues-grid { grid-template-columns: 1fr; }
            body { padding: 10px; }
            .header-left { flex-direction: column; align-items: flex-start; }
            .date-inputs { flex-direction: column; }
            h1 { font-size: 2rem; }
        }

        /* Toast и Error */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .error-msg {
            color: var(--danger-color);
            text-align: center;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <header>
            <div class="header-left">
                <h1><i class="fas fa-utensils"></i> Чи-Фань — Выручка и Аналитика</h1>
                <select class="period-selector" id="period-select">
                    <option value="today">Сегодня</option>
                    <option value="yesterday">Вчера</option>
                    <option value="week">Неделя</option>
                    <option value="month">Месяц</option>
                    <option value="custom">Выбрать период</option>
                </select>
                <div class="date-inputs" id="custom-dates" style="display: none;">
                    <label>
                        Начало:
                        <input type="date" id="start-date">
                    </label>
                    <label>
                        Конец:
                        <input type="date" id="end-date">
                    </label>
                    <button class="action-btn" onclick="loadCustomData()"><i class="fas fa-search"></i> Применить</button>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        </header>
        
        <div id="last-update"><i class="fas fa-clock"></i> Загрузка...</div>
        
        <div class="metrics-grid" id="metrics"></div>

        <div class="progress-container">
            <h3><i class="fas fa-chart-line"></i> Прогресс по плану</h3>
            <div class="progress-header">
                <span>Текущее: <span id="current-value">0 ₽</span></span>
                <span>План: <span id="plan-value">0 ₽</span></span>
            </div>
            <div class="progress-bar">
                <div id="plan-bar" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h4>Выручка по филиалам</h4>
                <canvas id="barChart1"></canvas>
            </div>
            <div class="chart-container">
                <h4>Статистика по типам</h4>
                <select class="data-selector" id="dataType" onchange="updateBarChart2()">
                    <option value="revenue">Выручка</option>
                    <option value="orders">Заказы</option>
                    <option value="delivery">Доставка</option>
                    <option value="cafe">Кафе</option>
                    <option value="pickup">Самовывоз</option>
                </select>
                <canvas id="barChart2"></canvas>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title"><i class="fas fa-building"></i> Круглогодичные филиалы</h3>
            <div class="venues-grid" id="year-round"></div>
        </div>

        <div class="section">
            <h3 class="section-title"><i class="fas fa-leaf"></i> Сезонные филиалы</h3>
            <div class="venues-grid" id="seasonal"></div>
        </div>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportPDF('all')"><i class="fas fa-file-pdf"></i> Экспорт PDF (Все)</button>
            <button class="export-btn" onclick="exportPDF('year-round')"><i class="fas fa-file-pdf"></i> PDF Круглогодичные</button>
            <button class="export-btn" onclick="exportPDF('seasonal')"><i class="fas fa-file-pdf"></i> PDF Сезонные</button>
            <button class="export-btn" onclick="exportImage()"><i class="fas fa-image"></i> Экспорт Графика</button>
        </div>

        <div id="toast" class="toast"></div>
    </div>

    <script>
    let barChart1, barChart2;
    let dataCache = {}; // Кэш данных

    const fmt = new Intl.NumberFormat('ru-RU');

    // --- Функции UI (без изменений) ---

    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        const icon = document.querySelector('.theme-toggle i');
        icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        updateChartTheme();
    }
    
    function updateChartTheme() {
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
        if (barChart1) {
            barChart1.options.scales.x.title.color = textColor;
            barChart1.options.scales.y.title.color = textColor;
            barChart1.options.scales.x.ticks.color = textColor;
            barChart1.options.scales.y.ticks.color = textColor;
            barChart1.options.plugins.legend.labels.color = textColor;
            barChart1.update();
        }
        if (barChart2) {
            barChart2.options.scales.x.title.color = textColor;
            barChart2.options.scales.y.title.color = textColor;
            barChart2.options.scales.x.ticks.color = textColor;
            barChart2.options.scales.y.ticks.color = textColor;
            barChart2.options.plugins.legend.labels.color = textColor;
            barChart2.update();
        }
    }

    function getStatusClass(fulfill) {
        if (fulfill >= 100) return 'good';
        if (fulfill >= 80) return 'warn';
        return 'bad';
    }
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.background = type === 'error' ? 'var(--danger-color)' : 'var(--success-color)';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // --- Функции Рендеринга (немного изменены) ---

    function renderMetrics(data) {
        // Используем данные из кэша, которые теперь будут обновляться из JSON
        const total = data.total || { total_revenue: 0, total_orders: 0 };
        const plan = data.plan || { total_revenue: 0, total_orders: 0 };
        
        // Вычисляем Средний чек и Маржинальность (если нет в JSON)
        const avg_bill = total.total_orders > 0 ? total.total_revenue / total.total_orders : 0;
        // Маржинальность (для примера, если нет в JSON, берем фиксированное значение)
        const margin = data.total.margin !== undefined ? data.total.margin : 18.5; 

        const revenueFulfill = plan.total_revenue ? (total.total_revenue / plan.total_revenue) * 100 : 0;
        const ordersFulfill = plan.total_orders ? (total.total_orders / plan.total_orders) * 100 : 0;
        
        const metricsHTML = `
            <div class="metric-card fade-in">
                <div class="metric-icon"><i class="fas fa-ruble-sign"></i></div>
                <div class="metric-value">${fmt.format(total.total_revenue)} ₽</div>
                <div class="metric-label">Выручка</div>
            </div>
            <div class="metric-card fade-in">
                <div class="metric-icon"><i class="fas fa-shopping-cart"></i></div>
                <div class="metric-value">${total.total_orders}</div>
                <div class="metric-label">Заказы</div>
            </div>
            <div class="metric-card fade-in">
                <div class="metric-icon"><i class="fas fa-receipt"></i></div>
                <div class="metric-value">${fmt.format(avg_bill)} ₽</div>
                <div class="metric-label">Средний чек</div>
            </div>
            <div class="metric-card fade-in">
                <div class="metric-icon"><i class="fas fa-percent"></i></div>
                <div class="metric-value">${margin.toFixed(1)}%</div>
                <div class="metric-label">Маржинальность</div>
            </div>
            <div class="metric-card fade-in">
                <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
                <div class="metric-value">${revenueFulfill.toFixed(1)}%</div>
                <div class="metric-label">Прогресс по выручке</div>
            </div>
        `;
        document.getElementById('metrics').innerHTML = metricsHTML;

        const bar = document.getElementById('plan-bar');
        const progressText = document.getElementById('progress-text');
        const currentValue = document.getElementById('current-value');
        const planValue = document.getElementById('plan-value');

        if (bar && progressText && currentValue && planValue) {
            bar.className = `progress-fill ${getStatusClass(revenueFulfill)}`;
            bar.style.width = Math.min(revenueFulfill, 100) + '%';
            progressText.textContent = `${revenueFulfill.toFixed(1)}%`;
            currentValue.textContent = `${fmt.format(total.total_revenue)} ₽`;
            planValue.textContent = `${fmt.format(plan.total_revenue)} ₽`;
        }

        if (revenueFulfill > 100) {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
    }

    function renderVenueCard(venue, stats) {
        // Использование ежедневного плана 1.5 млн / 30 = 50 000 ₽ на филиал для расчета
        // Если вы хотите использовать план из JSON, замените 50000 на dataCache.plan.total_revenue / (Object.keys(dataCache.year_round || {}).length + Object.keys(dataCache.seasonal || {}).length)
        const dailyPlanPerVenue = 50000; 
        const planRevenue = dailyPlanPerVenue;
        const fulfill = stats.total_revenue / planRevenue * 100;
        const statusClass = getStatusClass(fulfill);
        
        return `
            <div class="venue-card fade-in">
                <div class="venue-name">${venue}</div>
                <div class="venue-metric"><span>Выручка:</span> <span class="venue-metric-value ${statusClass}">${fmt.format(stats.total_revenue)} ₽</span></div>
                <div class="venue-metric"><span>Заказы:</span> <span>${stats.total_orders}</span></div>
                <div class="venue-metric"><span>Доставка:</span> <span>${fmt.format(stats.delivery_revenue || 0)} ₽</span></div>
                <div class="venue-metric"><span>Кафе:</span> <span>${fmt.format(stats.cafe_revenue || 0)} ₽</span></div>
                <div class="venue-metric"><span>Самовывоз:</span> <span>${fmt.format(stats.pickup_revenue || 0)} ₽</span></div>
                <div style="margin-top: 10px;">
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill ${statusClass}" style="width: ${Math.min(fulfill, 100)}%;"></div>
                    </div>
                    <small>${fulfill.toFixed(1)}% от плана (${fmt.format(planRevenue)} ₽)</small>
                </div>
            </div>
        `;
    }

    function renderVenues(data, containerId) {
        const key = containerId === 'year-round' ? 'year_round' : 'seasonal';
        const venues = data[key] || {};
        const container = document.getElementById(containerId);
        
        if (!container) return;

        if (Object.keys(venues).length === 0) {
            container.innerHTML = '<div class="error-msg">Нет данных по филиалам</div>';
            return;
        }
        
        const sortedVenues = Object.entries(venues).sort((a, b) => b[1].total_revenue - a[1].total_revenue);
        container.innerHTML = sortedVenues.map(([venue, stats]) => renderVenueCard(venue, stats)).join('');
    }

    function renderCharts(data) {
        const allVenues = { ...data.year_round, ...data.seasonal };
        const labels = Object.keys(allVenues);
        const revenues = labels.map(l => allVenues[l].total_revenue || 0);

        const ctxBar1 = document.getElementById('barChart1')?.getContext('2d');
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
        
        if (ctxBar1 && labels.length > 0) {
            if (barChart1) barChart1.destroy();
            barChart1 = new Chart(ctxBar1, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Выручка ₽', 
                        data: revenues, 
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'] 
                    }] 
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Филиалы', color: textColor }, ticks: { color: textColor } },
                        y: { beginAtZero: true, title: { display: true, text: 'Выручка ₽', color: textColor }, ticks: { color: textColor } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                }
            });
        }

        updateBarChart2();
    }

    function updateBarChart2() {
        const dataType = document.getElementById('dataType')?.value || 'revenue';
        const allVenues = { ...dataCache.year_round, ...dataCache.seasonal };
        const labels = Object.keys(allVenues);
        const ctxBar2 = document.getElementById('barChart2')?.getContext('2d');
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
        let dataValues, chartLabel, yAxisText;

        switch(dataType) {
            case 'orders':
                dataValues = labels.map(l => allVenues[l].total_orders || 0);
                chartLabel = 'Заказы';
                yAxisText = 'Количество заказов';
                break;
            case 'delivery':
                dataValues = labels.map(l => allVenues[l].delivery_revenue || 0);
                chartLabel = 'Доставка ₽';
                yAxisText = 'Выручка ₽';
                break;
            case 'cafe':
                dataValues = labels.map(l => allVenues[l].cafe_revenue || 0);
                chartLabel = 'Кафе ₽';
                yAxisText = 'Выручка ₽';
                break;
            case 'pickup':
                dataValues = labels.map(l => allVenues[l].pickup_revenue || 0);
                chartLabel = 'Самовывоз ₽';
                yAxisText = 'Выручка ₽';
                break;
            default: // revenue
                dataValues = labels.map(l => allVenues[l].total_revenue || 0);
                chartLabel = 'Выручка ₽';
                yAxisText = 'Выручка ₽';
        }

        if (ctxBar2 && labels.length > 0) {
            if (barChart2) barChart2.destroy();
            barChart2 = new Chart(ctxBar2, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: chartLabel, 
                        data: dataValues, 
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'] 
                    }] 
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Филиалы', color: textColor }, ticks: { color: textColor } },
                        y: { beginAtZero: true, title: { display: true, text: yAxisText, color: textColor }, ticks: { color: textColor } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                }
            });
        }
    }

    // --- Функции Периода и Загрузки Данных (Упрощенная имитация) ---

    document.getElementById('period-select').addEventListener('change', function() {
        const customDatesDiv = document.getElementById('custom-dates');
        if (this.value === 'custom') {
            customDatesDiv.style.display = 'flex';
        } else {
            customDatesDiv.style.display = 'none';
            load(); 
            showToast(`Выбран период: ${this.options[this.selectedIndex].text}`);
        }
    });

    function loadCustomData() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        if (!startDate || !endDate) {
            showToast('Пожалуйста, выберите начальную и конечную дату', 'error');
            return;
        }
        showToast(`Загрузка данных за период: ${startDate} по ${endDate}`);
        load(); 
    }


    // --- Функции Экспорта (без изменений) ---

    function exportPDF(filter = 'all') {
        if (!dataCache.date) {
            showToast('Нет данных для экспорта', 'error');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        function escapeText(text) {
            return text.normalize('NFKD').replace(/[^\x00-\x7F\u0400-\u04FF]/g, ''); 
        }
        
        doc.setFont("helvetica");
        doc.setFontSize(14);
        doc.text('Чи-Фань Отчет по Выручке', 10, 10);
        doc.setFontSize(10);
        const dateText = `Дата отчета: ${dataCache.date || 'N/A'} ${dataCache.time || 'N/A'}`;
        doc.text(dateText, 10, 15);

        let y = 25;
        const venues = filter === 'year-round' ? dataCache.year_round : filter === 'seasonal' ? dataCache.seasonal : { ...dataCache.year_round, ...dataCache.seasonal };
        
        Object.entries(venues || {}).forEach(([v, s]) => {
            const text = `${v}: Выручка ${fmt.format(s.total_revenue)} ₽, Заказы ${s.total_orders}`;
            doc.text(escapeText(text), 10, y);
            y += 7;
            if (y > 280) {
                doc.addPage();
                y = 15;
            }
        });

        doc.save(`chifan_report_${dataCache.date || 'today'}_${filter}.pdf`);
        showToast('PDF экспортирован!');
    }
    
    function exportImage() {
        const canvas = document.getElementById('barChart1');
        if (canvas) {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'chifan_chart.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('График экспортирован как PNG!');
        } else {
            showToast('Ошибка: График не найден', 'error');
        }
    }

    // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ ДАННЫХ ---

    async function fetchLatestData() {
        // Ваши предоставленные данные для имитации загрузки
        const rawData = {
            "date": "2025-10-05",
            "time": "00:51",
            "year_round": {
                "Светланская": { "total_orders": 83, "delivery_orders": 0, "pickup_orders": 19, "cafe_orders": 64, "total_revenue": 49796.0, "delivery_revenue": 0, "pickup_revenue": 10982.0, "cafe_revenue": 38814.0 },
                "Парк": { "total_orders": 59, "delivery_orders": 0, "pickup_orders": 1, "cafe_orders": 58, "total_revenue": 32066.0, "delivery_revenue": 0, "pickup_revenue": 368.0, "cafe_revenue": 31698.0 },
                "Красота": { "total_orders": 136, "delivery_orders": 68, "pickup_orders": 22, "cafe_orders": 46, "total_revenue": 146651.0, "delivery_revenue": 105500.0, "pickup_revenue": 14904.0, "cafe_revenue": 26247.0 },
                "Тобольская": { "total_orders": 118, "delivery_orders": 40, "pickup_orders": 25, "cafe_orders": 53, "total_revenue": 110212.0, "delivery_revenue": 60751.0, "pickup_revenue": 19367.0, "cafe_revenue": 30094.0 },
                "Тихая": { "total_orders": 98, "delivery_orders": 19, "pickup_orders": 20, "cafe_orders": 59, "total_revenue": 79678.0, "delivery_revenue": 30543.0, "pickup_revenue": 12689.0, "cafe_revenue": 36446.0 },
                "Чуркин": { "total_orders": 84, "delivery_orders": 0, "pickup_orders": 10, "cafe_orders": 74, "total_revenue": 55079.0, "delivery_revenue": 0, "pickup_revenue": 5556.0, "cafe_revenue": 49523.0 }
            },
            "seasonal": {
                "Кунгас": { "total_orders": 90, "delivery_orders": 0, "pickup_orders": 1, "cafe_orders": 89, "total_revenue": 48007.0, "delivery_revenue": 0, "pickup_revenue": 588.0, "cafe_revenue": 47419.0 },
                "МГУ": { "total_orders": 34, "delivery_orders": 0, "pickup_orders": 6, "cafe_orders": 28, "total_revenue": 15767.0, "delivery_revenue": 0, "pickup_revenue": 2437.0, "cafe_revenue": 13330.0 },
                "Юбилейный": { "total_orders": 284, "delivery_orders": 0, "pickup_orders": 1, "cafe_orders": 283, "total_revenue": 148362.0, "delivery_revenue": 0, "pickup_revenue": 169.0, "cafe_revenue": 148193.0 }
            },
            // Заглушка для плана (1.5 млн в месяц / 30 дней)
            "plan": {
                "total_revenue": 500000, // 1 500 000 ₽ / 30 дней = 50 000 ₽/день. Установим для примера 500 000 ₽/день.
                "total_orders": 1000 // Примерный ежедневный план заказов
            }
        };

        // В РЕАЛЬНОМ приложении вы бы здесь делали fetch()
        // и использовали данные, которые вам возвращаются.

        // **ИСПРАВЛЕНИЕ: Используем фактические общие суммы из JSON**
        // Хотя ваш JSON уже имеет секцию "total", мы пересчитаем ее для надежности,
        // чтобы гарантировать, что данные на экране совпадают с данными в филиалах.
        let calculatedRevenue = 0;
        let calculatedOrders = 0;
        
        const allVenues = { ...rawData.year_round, ...rawData.seasonal };
        
        Object.values(allVenues).forEach(stats => {
            calculatedRevenue += stats.total_revenue;
            calculatedOrders += stats.total_orders;
        });
        
        // Создаем финальный объект данных
        const finalData = {
            ...rawData,
            total: {
                total_revenue: calculatedRevenue,
                total_orders: calculatedOrders,
                // Добавляем вычисленный средний чек и фиксированную маржу для отображения
                avg_bill: calculatedOrders > 0 ? calculatedRevenue / calculatedOrders : 0,
                margin: 18.5 
            }
        };

        return new Promise(resolve => setTimeout(() => resolve(finalData), 500));
    }

    async function load() {
        const updateEl = document.getElementById('last-update');
        if (updateEl) updateEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';

        try {
            // Загружает данные из имитации с реальными общими показателями
            const data = await fetchLatestData(); 
            dataCache = data; 

            if (updateEl) updateEl.innerHTML = `<i class="fas fa-check-circle"></i> Обновлено: ${data.time} (${data.date})`;

            renderMetrics(data);
            renderVenues(data, 'year-round');
            renderVenues(data, 'seasonal');
            renderCharts(data);
            
            updateChartTheme();

            // Отображение актуальных данных, а не фиксированных
            showToast(`Данные обновлены! Выручка: ${fmt.format(data.total.total_revenue)} ₽`);
        } catch (e) {
            console.error('Ошибка загрузки:', e);
            if (updateEl) updateEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка загрузки';
            document.getElementById('metrics').innerHTML = '<div class="error-msg">Ошибка загрузки метрик</div>';
            showToast('Ошибка загрузки данных', 'error');
        } finally {
            document.querySelectorAll('.metric-card, .venue-card').forEach((el, index) => {
                setTimeout(() => el.classList.add('fade-in'), index * 100);
            });
        }
    }

    // --- Инициализация ---

    if (localStorage.getItem('theme') === 'dark') toggleTheme();
    
    load();
    
    // Обновление каждые 5 минут
    setInterval(load, 5 * 60 * 1000); 
</script>
