<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чи-Фань — Аналитика выручки</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --success-color: #00c853;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.15);
            --accent-color: #1a237e;
            --border-radius: 8px;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #9e9e9e;
            --border-color: #333333;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.4);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .info-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-range-selector {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            padding: 16px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .date-range-selector label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .date-range-selector input, 
        .date-range-selector button,
        .data-selector {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .date-range-selector button {
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-range-selector button:hover {
            background: var(--secondary-color);
        }

        .quick-periods {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .period-btn {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .period-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .period-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--accent-color);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .metric-icon {
            font-size: 1.8rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .metric-change {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .metric-change.positive {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success-color);
        }

        .metric-change.negative {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .progress-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .progress-bar {
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 10px;
        }

        .progress-fill.good { background: linear-gradient(90deg, var(--success-color), #00a845); }
        .progress-fill.warn { background: linear-gradient(90deg, var(--warning-color), #d97706); }
        .progress-fill.bad { background: linear-gradient(90deg, var(--danger-color), #dc2626); }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .venues-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .venues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .venue-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-top: 3px solid var(--accent-color);
        }

        .venue-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .venue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .venue-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .venue-details-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .venue-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .venue-metric {
            display: flex;
            flex-direction: column;
        }

        .venue-metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .venue-metric-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .orders-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .order-type {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
        }

        .order-type.delivery { background: rgba(16, 185, 129, 0.1); }
        .order-type.pickup { background: rgba(245, 158, 11, 0.1); }
        .order-type.cafe { background: rgba(139, 92, 246, 0.1); }

        .order-type-value {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .order-type-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: var(--secondary-color);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .toast.show {
            opacity: 1;
        }

        .error-msg {
            color: var(--danger-color);
            text-align: center;
            padding: 12px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: var(--border-radius);
            margin: 10px 0;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }

        .data-source-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
            font-style: italic;
        }

        .auto-refresh-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .comparison-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .comparison-option {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comparison-option.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .venues-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .date-range-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .quick-periods {
                width: 100%;
                justify-content: space-between;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-good {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success-color);
        }

        .status-warn {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }

        .status-bad {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Чи-Фань — Аналитика выручки</h1>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i> Тема
            </button>
        </header>

        <div class="info-panel">
            <div id="last-update">
                <i class="fas fa-clock"></i> Загрузка данных...
            </div>
            <div id="business-day-info">
                <i class="fas fa-calendar-day"></i> Бизнес-день: <span id="business-day-date"></span>
            </div>
        </div>

        <div class="date-range-selector">
            <div style="display: flex; gap: 10px; align-items: center;">
                <label for="start-date">С:</label>
                <input type="date" id="start-date">
                <label for="end-date">По:</label>
                <input type="date" id="end-date">
                <button onclick="loadCustomData()">
                    <i class="fas fa-download"></i> Загрузить
                </button>
            </div>
            
            <div class="quick-periods">
                <button class="period-btn" onclick="setPeriod('today')">Сегодня</button>
                <button class="period-btn" onclick="setPeriod('yesterday')">Вчера</button>
                <button class="period-btn" onclick="setPeriod('thisWeek')">Неделя</button>
                <button class="period-btn" onclick="setPeriod('thisMonth')">Месяц</button>
                <button class="period-btn" onclick="setPeriod('lastMonth')">Прошлый месяц</button>
            </div>
        </div>

        <div class="comparison-selector">
            <span>Сравнение:</span>
            <div class="comparison-option active" onclick="setComparisonType('none')">Нет</div>
            <div class="comparison-option" onclick="setComparisonType('previous_period')">С предыдущим периодом</div>
            <div class="comparison-option" onclick="setComparisonType('previous_year')">С прошлым годом</div>
        </div>

        <div class="metrics-grid" id="metrics"></div>

        <div class="progress-container">
            <h3><i class="fas fa-chart-line"></i> Прогресс по плану</h3>
            <div class="progress-header">
                <span>Факт: <span id="current-value">0 ₽</span></span>
                <span>План: <span id="plan-value">0 ₽</span></span>
            </div>
            <div class="progress-bar">
                <div id="plan-bar" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Выручка по филиалам</div>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Типы заказов</div>
                <canvas id="ordersChart"></canvas>
            </div>
        </div>

        <div class="venues-section">
            <h3 class="section-title"><i class="fas fa-building"></i> Круглогодичные филиалы</h3>
            <div class="venues-grid" id="year-round"></div>
        </div>

        <div class="venues-section">
            <h3 class="section-title"><i class="fas fa-leaf"></i> Сезонные филиалы</h3>
            <div class="venues-grid" id="seasonal"></div>
        </div>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportPDF('all')">
                <i class="fas fa-file-pdf"></i> Экспорт PDF (Все)
            </button>
            <button class="export-btn" onclick="exportPDF('year-round')">
                <i class="fas fa-file-pdf"></i> PDF Круглогодичные
            </button>
            <button class="export-btn" onclick="exportPDF('seasonal')">
                <i class="fas fa-file-pdf"></i> PDF Сезонные
            </button>
        </div>

        <div class="auto-refresh-info">
            <i class="fas fa-sync-alt"></i> Автообновление каждые 5 минут
        </div>

        <div id="toast" class="toast"></div>
    </div>

    <script>
        // Константы и настройки
        const DAILY_NETWORK_PLAN = 50000;
        const BASE_DATA_URL = 'https://raw.githubusercontent.com/wwwgolybfs-dev/chifan2025/main/data/daily/';
        const LATEST_DATA_URL = 'https://raw.githubusercontent.com/wwwgolybfs-dev/chifan2025/main/data/revenue.json';
        const fmt = new Intl.NumberFormat('ru-RU');
        const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 минут
        
        const fixedDailyPlans = {
            "Тобольская": 70000,
            "Тихая": 55000,
            "Красота": 80000,
            "Светланская": 60000,
            "Парк": 50000,
            "Чуркин": 65000,
            "Кунгас": 40000,
            "МГУ": 30000,
            "Юбилейный": 35000
        };

        // Переменные состояния
        let revenueChart, ordersChart;
        let dataCache = {};
        let currentStartDate = '';
        let currentEndDate = '';
        let activePeriod = 'today';
        let comparisonType = 'none';
        let autoRefreshInterval;
        let lastDataHash = '';

        // Утилиты
        function getCurrentBusinessDay() {
            const now = new Date();
            if (now.getHours() < 3) {
                now.setDate(now.getDate() - 1);
            }
            return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }

        function getTodayDateString() {
            return formatDateForInput(getCurrentBusinessDay());
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWeekStartDate(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            return d;
        }

        function getWeekEndDate(date = new Date()) {
            const start = getWeekStartDate(date);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return end;
        }

        function getMonthStartDate(date = new Date()) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        function getMonthEndDate(date = new Date()) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0);
        }

        function getLastMonthStartDate() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth() - 1, 1);
        }

        function getLastMonthEndDate() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 0);
        }

        function getDiffDays(startDateStr, endDateStr) {
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            if (isNaN(start) || isNaN(end)) return 1;
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function calculateDailyPlanFromMonthly(monthlyPlan, dateStr) {
            if (!monthlyPlan || monthlyPlan === 0) {
                return DAILY_NETWORK_PLAN;
            }
            
            try {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                return monthlyPlan / daysInMonth;
            } catch (e) {
                console.warn('Ошибка расчета дневного плана:', e);
                return DAILY_NETWORK_PLAN;
            }
        }

        function getStatusClass(percentage) {
            if (percentage >= 100) return 'good';
            if (percentage >= 80) return 'warn';
            return 'bad';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.style.background = type === 'error' ? 'var(--danger-color)' : 
                                   type === 'warning' ? 'var(--warning-color)' : 'var(--success-color)';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Управление темой
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.querySelector('.theme-toggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            updateChartThemes();
        }

        function updateChartThemes() {
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim();
            
            const chartOptions = {
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                }
            };
            
            if (revenueChart) {
                revenueChart.options = { ...revenueChart.options, ...chartOptions };
                revenueChart.update();
            }
            
            if (ordersChart) {
                ordersChart.options = { ...ordersChart.options, ...chartOptions };
                ordersChart.update();
            }
        }

        // Управление периодами
        function setPeriod(period) {
            const businessDay = getCurrentBusinessDay();
            let startDate, endDate;
            
            // Сброс активного класса у всех кнопок
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Установка активного класса нажатой кнопке
            event.target.classList.add('active');
            activePeriod = period;
            
            switch(period) {
                case 'today':
                    startDate = new Date(businessDay);
                    endDate = new Date(businessDay);
                    break;
                case 'yesterday':
                    const yesterday = new Date(businessDay);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = yesterday;
                    endDate = yesterday;
                    break;
                case 'thisWeek':
                    startDate = getWeekStartDate(businessDay);
                    endDate = getWeekEndDate(businessDay);
                    break;
                case 'thisMonth':
                    startDate = getMonthStartDate(businessDay);
                    endDate = businessDay;
                    break;
                case 'lastMonth':
                    startDate = getLastMonthStartDate();
                    endDate = getLastMonthEndDate();
                    break;
            }
            
            document.getElementById('start-date').value = formatDateForInput(startDate);
            document.getElementById('end-date').value = formatDateForInput(endDate);
            loadCustomData();
        }

        function setComparisonType(type) {
            comparisonType = type;
            
            // Обновление активного класса
            document.querySelectorAll('.comparison-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Перезагрузка данных с учетом сравнения
            if (currentStartDate && currentEndDate) {
                load(currentStartDate, currentEndDate);
            }
        }

        // Загрузка данных
        async function fetchDataForDate(dateStr) {
            const todayStr = getTodayDateString();
            const isToday = dateStr === todayStr;
            
            const urls = isToday ? 
                [`${LATEST_DATA_URL}?t=${Date.now()}`, `${BASE_DATA_URL}${dateStr}_revenue.json?t=${Date.now()}`] :
                [`${BASE_DATA_URL}${dateStr}_revenue.json?t=${Date.now()}`];
            
            for (const url of urls) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Проверка даты для latest данных
                    if (url.includes('revenue.json') && !url.includes('daily')) {
                        if (data.date && data.date !== dateStr) {
                            continue;
                        }
                    }
                    
                    // Расчет агрегированных данных
                    let calculatedRevenue = 0;
                    let calculatedOrders = 0;
                    let calculatedDeliveryOrders = 0;
                    let calculatedPickupOrders = 0;
                    let calculatedCafeOrders = 0;
                    
                    const allVenues = { ...data.year_round, ...data.seasonal };
                    Object.values(allVenues).forEach(stats => {
                        calculatedRevenue += stats.total_revenue || 0;
                        calculatedOrders += stats.total_orders || 0;
                        calculatedDeliveryOrders += stats.delivery_orders || 0;
                        calculatedPickupOrders += stats.pickup_orders || 0;
                        calculatedCafeOrders += stats.cafe_orders || 0;
                    });
                    
                    // Обработка плана
                    const planRevenue = data.plan?.revenue || data.plan?.total_revenue || DAILY_NETWORK_PLAN;
                    const planOrders = data.plan?.orders || data.plan?.total_orders || 1000;
                    
                    const result = {
                        ...data,
                        plan: { revenue: planRevenue, orders: planOrders },
                        total: {
                            total_revenue: calculatedRevenue || data.total?.total_revenue || 0,
                            total_orders: calculatedOrders || data.total?.total_orders || 0,
                            total_delivery_orders: calculatedDeliveryOrders,
                            total_pickup_orders: calculatedPickupOrders,
                            total_cafe_orders: calculatedCafeOrders
                        },
                        _source: url.includes('revenue.json') && !url.includes('daily') ? 'latest' : 'daily'
                    };
                    
                    dataCache[dateStr] = result;
                    return result;
                } catch (error) {
                    console.warn(`Ошибка загрузки ${url}:`, error);
                    showToast(`Ошибка загрузки из ${url}`, 'error');
                }
            }

            // Возврат пустых данных, если файл не найден
            return {
                date: dateStr,
                time: "00:00",
                year_round: {},
                seasonal: {},
                plan: { revenue: DAILY_NETWORK_PLAN, orders: 1000 },
                total: {
                    total_revenue: 0,
                    total_orders: 0,
                    total_delivery_orders: 0,
                    total_pickup_orders: 0,
                    total_cafe_orders: 0
                },
                _source: 'empty'
            };
        }

        async function loadData(startDateStr, endDateStr) {
            const diffDays = getDiffDays(startDateStr, endDateStr);
            let combinedData = {
                year_round: {},
                seasonal: {},
                total: {
                    total_revenue: 0,
                    total_orders: 0,
                    total_delivery_orders: 0,
                    total_pickup_orders: 0,
                    total_cafe_orders: 0
                },
                date: `${startDateStr} - ${endDateStr}`,
                time: "23:59",
                _sources: new Set()
            };
            
            // Генерация списка дат
            const dateList = [];
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            if (isNaN(currentDate) || isNaN(endDate) || currentDate > endDate) {
                showToast('Неверный диапазон дат', 'error');
                combinedData.plan = {
                    total_revenue: DAILY_NETWORK_PLAN * diffDays,
                    total_orders: 1000 * diffDays
                };
                return combinedData;
            }
            
            while (currentDate <= endDate) {
                dateList.push(formatDateForInput(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let totalDailyPlanRevenue = 0;
            let totalDailyPlanOrders = 0;
            let totalActualRevenue = 0;
            let totalActualOrders = 0;
            let totalActualDeliveryOrders = 0;
            let totalActualPickupOrders = 0;
            let totalActualCafeOrders = 0;
            
            // Загрузка данных за каждую дату
            const promises = dateList.map(dateStr => fetchDataForDate(dateStr));
            const dailyResults = await Promise.all(promises);
            
            dailyResults.forEach(dailyData => {
                if (!dailyData) return;
                
                // Суммирование фактических данных
                totalActualRevenue += dailyData.total.total_revenue || 0;
                totalActualOrders += dailyData.total.total_orders || 0;
                totalActualDeliveryOrders += dailyData.total.total_delivery_orders || 0;
                totalActualPickupOrders += dailyData.total.total_pickup_orders || 0;
                totalActualCafeOrders += dailyData.total.total_cafe_orders || 0;
                
                combinedData._sources.add(dailyData._source);
                
                // Объединение данных по филиалам
                const venuesToCombine = { ...dailyData.year_round, ...dailyData.seasonal };
                for (const venue in venuesToCombine) {
                    const stats = venuesToCombine[venue];
                    let existingStats = combinedData.year_round[venue] || combinedData.seasonal[venue];
                    
                    if (!existingStats) {
                        const target = dailyData.year_round[venue] ? 
                            combinedData.year_round : combinedData.seasonal;
                        target[venue] = { ...stats };
                    } else {
                        for (const key in stats) {
                            if (typeof stats[key] === 'number') {
                                existingStats[key] = (existingStats[key] || 0) + (stats[key] || 0);
                            }
                        }
                    }
                }
                
                // Расчет дневного плана
                const monthlyRevenuePlan = dailyData.plan?.revenue;
                const monthlyOrdersPlan = dailyData.plan?.orders;
                
                const dailyPlanRevenue = calculateDailyPlanFromMonthly(monthlyRevenuePlan, dailyData.date);
                const dailyPlanOrders = calculateDailyPlanFromMonthly(monthlyOrdersPlan, dailyData.date);
                
                totalDailyPlanRevenue += isNaN(dailyPlanRevenue) ? DAILY_NETWORK_PLAN : dailyPlanRevenue;
                totalDailyPlanOrders += isNaN(dailyPlanOrders) ? 1000 : dailyPlanOrders;
            });
            
            combinedData.total = {
                total_revenue: totalActualRevenue,
                total_orders: totalActualOrders,
                total_delivery_orders: totalActualDeliveryOrders,
                total_pickup_orders: totalActualPickupOrders,
                total_cafe_orders: totalActualCafeOrders
            };
            
            combinedData.plan = {
                total_revenue: totalDailyPlanRevenue,
                total_orders: totalDailyPlanOrders
            };
            
            if (diffDays === 1 && dailyResults[0] && dailyResults[0].time !== "00:00") {
                combinedData.time = dailyResults[0].time;
            }
            
            return combinedData;
        }

        // Визуализация
        function renderMetrics(data) {
            const total = data.total || {
                total_revenue: 0,
                total_orders: 0,
                total_delivery_orders: 0,
                total_pickup_orders: 0,
                total_cafe_orders: 0
            };
            
            const plan = data.plan || {
                total_revenue: DAILY_NETWORK_PLAN,
                total_orders: 1000
            };
            
            const avgBill = total.total_orders > 0 ? total.total_revenue / total.total_orders : 0;
            const revenuePercentage = plan.total_revenue > 0 ? (total.total_revenue / plan.total_revenue) * 100 : 0;
            const ordersPercentage = plan.total_orders > 0 ? (total.total_orders / plan.total_orders) * 100 : 0;
            
            let sourceInfo = '';
            if (data._sources) {
                const sources = Array.from(data._sources);
                if (sources.includes('latest')) {
                    sourceInfo = '<div class="data-source-info">📊 Данные в реальном времени</div>';
                } else if (sources.includes('daily')) {
                    sourceInfo = '<div class="data-source-info">📁 Архивные данные</div>';
                }
            }
            
            document.getElementById('metrics').innerHTML = `
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-ruble-sign"></i></div>
                    <div class="metric-value">${fmt.format(total.total_revenue.toFixed(0))} ₽</div>
                    <div class="metric-label">Общая выручка</div>
                    ${sourceInfo}
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-shopping-cart"></i></div>
                    <div class="metric-value">${fmt.format(total.total_orders)}</div>
                    <div class="metric-label">Всего заказов</div>
                    <div class="orders-breakdown" style="margin-top: 10px;">
                        <div class="order-type delivery">
                            <div class="order-type-value">${total.total_delivery_orders || 0}</div>
                            <div class="order-type-label">Доставка</div>
                        </div>
                        <div class="order-type pickup">
                            <div class="order-type-value">${total.total_pickup_orders || 0}</div>
                            <div class="order-type-label">Самовывоз</div>
                        </div>
                        <div class="order-type cafe">
                            <div class="order-type-value">${total.total_cafe_orders || 0}</div>
                            <div class="order-type-label">Кафе</div>
                        </div>
                    </div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-receipt"></i></div>
                    <div class="metric-value">${fmt.format(avgBill.toFixed(0))} ₽</div>
                    <div class="metric-label">Средний чек</div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-percent"></i></div>
                    <div class="metric-value ${getStatusClass(revenuePercentage)}">${revenuePercentage.toFixed(1)}%</div>
                    <div class="metric-label">Выполнение плана</div>
                    <div class="data-source-info">План: ${fmt.format(plan.total_revenue.toFixed(0))} ₽</div>
                </div>
            `;
            
            // Обновление прогресс-бара
            const bar = document.getElementById('plan-bar');
            const progressText = document.getElementById('progress-text');
            const currentValue = document.getElementById('current-value');
            const planValue = document.getElementById('plan-value');
            
            if (bar && progressText && currentValue && planValue) {
                bar.className = `progress-fill ${getStatusClass(revenuePercentage)}`;
                bar.style.width = `${Math.min(revenuePercentage, 100)}%`;
                progressText.textContent = `${revenuePercentage.toFixed(1)}%`;
                currentValue.textContent = `${fmt.format(total.total_revenue.toFixed(0))} ₽`;
                planValue.textContent = `${fmt.format(plan.total_revenue.toFixed(0))} ₽`;
            }
            
            // Анимация при перевыполнении плана
            if (revenuePercentage > 100) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        function renderVenues(data, containerId) {
            const key = containerId === 'year-round' ? 'year_round' : 'seasonal';
            const venues = data[key] || {};
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            if (Object.keys(venues).length === 0) {
                container.innerHTML = '<div class="error-msg">Нет данных по филиалам</div>';
                return;
            }
            
            const periodDays = getDiffDays(currentStartDate, currentEndDate);
            const sortedVenues = Object.entries(venues)
                .sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            
            container.innerHTML = sortedVenues.map(([venue, stats]) => 
                renderVenueCard(venue, stats, periodDays)
            ).join('');
        }

        function renderVenueCard(venue, stats, periodDays) {
            const dailyPlan = fixedDailyPlans[venue] || DAILY_NETWORK_PLAN;
            const planRevenueForPeriod = dailyPlan * periodDays;
            const percentage = planRevenueForPeriod > 0 ? 
                (stats.total_revenue || 0) / planRevenueForPeriod * 100 : 0;
            const statusClass = getStatusClass(percentage);
            
            const avgCheck = stats.total_orders > 0 ? 
                (stats.total_revenue || 0) / stats.total_orders : 0;
            
            return `
                <div class="venue-card fade-in">
                    <div class="venue-header">
                        <div class="venue-name">${venue}</div>
                        <span class="status-badge status-${statusClass}">
                            ${percentage.toFixed(1)}%
                        </span>
                    </div>
                    
                    <div class="venue-metrics">
                        <div class="venue-metric">
                            <div class="venue-metric-label">Выручка</div>
                            <div class="venue-metric-value">${fmt.format((stats.total_revenue || 0).toFixed(0))} ₽</div>
                        </div>
                        <div class="venue-metric">
                            <div class="venue-metric-label">Заказы</div>
                            <div class="venue-metric-value">${stats.total_orders || 0}</div>
                        </div>
                        <div class="venue-metric">
                            <div class="venue-metric-label">Средний чек</div>
                            <div class="venue-metric-value">${fmt.format(avgCheck.toFixed(0))} ₽</div>
                        </div>
                        <div class="venue-metric">
                            <div class="venue-metric-label">План</div>
                            <div class="venue-metric-value">${fmt.format(planRevenueForPeriod.toFixed(0))} ₽</div>
                        </div>
                    </div>
                    
                    <div class="orders-breakdown">
                        <div class="order-type delivery">
                            <div class="order-type-value">${stats.delivery_orders || 0}</div>
                            <div class="order-type-label">Доставка</div>
                        </div>
                        <div class="order-type pickup">
                            <div class="order-type-value">${stats.pickup_orders || 0}</div>
                            <div class="order-type-label">Самовывоз</div>
                        </div>
                        <div class="order-type cafe">
                            <div class="order-type-value">${stats.cafe_orders || 0}</div>
                            <div class="order-type-label">Кафе</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCharts(data) {
            const allVenues = { ...data.year_round, ...data.seasonal };
            const labels = Object.keys(allVenues);
            const revenues = labels.map(venue => allVenues[venue]?.total_revenue || 0);
            
            const ctxRevenue = document.getElementById('revenueChart')?.getContext('2d');
            const ctxOrders = document.getElementById('ordersChart')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            
            // График выручки по филиалам
            if (ctxRevenue && revenueChart) {
                revenueChart.destroy();
            }
            
            if (ctxRevenue) {
                revenueChart = new Chart(ctxRevenue, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Выручка (₽)',
                            data: revenues,
                            backgroundColor: [
                                '#1a237e', '#283593', '#303f9f', '#3949ab', 
                                '#3f51b5', '#5c6bc0', '#7986cb', '#9fa8da'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Выручка: ${fmt.format(context.raw)} ₽`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return fmt.format(value) + ' ₽';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // График типов заказов
            const orderTypes = {
                'Доставка': data.total.total_delivery_orders || 0,
                'Самовывоз': data.total.total_pickup_orders || 0,
                'Кафе': data.total.total_cafe_orders || 0
            };
            
            if (ctxOrders && ordersChart) {
                ordersChart.destroy();
            }
            
            if (ctxOrders) {
                ordersChart = new Chart(ctxOrders, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(orderTypes),
                        datasets: [{
                            data: Object.values(orderTypes),
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            updateChartThemes();
        }

        // Управление загрузкой
        function loadCustomData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showToast('Выберите начальную и конечную дату', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showToast('Начальная дата не может быть позже конечной', 'error');
                return;
            }
            
            const periodText = startDate === endDate ? 
                `за ${new Date(startDate).toLocaleDateString('ru-RU')}` :
                `с ${new Date(startDate).toLocaleDateString('ru-RU')} по ${new Date(endDate).toLocaleDateString('ru-RU')}`;
            
            showToast(`Загрузка данных ${periodText}`);
            load(startDate, endDate);
        }

        async function load(startDateStr, endDateStr) {
            const updateEl = document.getElementById('last-update');
            if (updateEl) {
                updateEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
            }
            
            currentStartDate = startDateStr;
            currentEndDate = endDateStr;
            
            // Очистка кеша для текущего бизнес-дня
            const businessDay = getCurrentBusinessDay();
            const todayStr = formatDateForInput(businessDay);
            
            if (startDateStr === todayStr || endDateStr === todayStr) {
                delete dataCache[todayStr];
            }
            
            try {
                const data = await loadData(startDateStr, endDateStr);
                if (!data) {
                    throw new Error('Данные не получены');
                }
                dataCache.current = data;
                
                // Проверка на новые данные
                const currentDataHash = JSON.stringify(data.total);
                if (lastDataHash && lastDataHash !== currentDataHash) {
                    showToast('Обновлены данные', 'success');
                }
                lastDataHash = currentDataHash;
                
                // Обновление интерфейса
                let dateDisplay;
                if (startDateStr && endDateStr) {
                    dateDisplay = startDateStr === endDateStr ? 
                        new Date(startDateStr).toLocaleDateString('ru-RU') :
                        `${new Date(startDateStr).toLocaleDateString('ru-RU')} - ${new Date(endDateStr).toLocaleDateString('ru-RU')}`;
                }
                
                if (updateEl) {
                    updateEl.innerHTML = `<i class="fas fa-check-circle"></i> Обновлено: ${data.time} (${dateDisplay})`;
                }
                
                renderMetrics(data);
                renderVenues(data, 'year-round');
                renderVenues(data, 'seasonal');
                renderCharts(data);
                
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                if (updateEl) {
                    updateEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка загрузки';
                }
                
                document.getElementById('metrics').innerHTML = '<div class="error-msg">Ошибка загрузки метрик: ' + error.message + '</div>';
                document.getElementById('year-round').innerHTML = '<div class="error-msg">Ошибка загрузки данных по круглогодичным филиалам</div>';
                document.getElementById('seasonal').innerHTML = '<div class="error-msg">Ошибка загрузки данных по сезонным филиалам</div>';
                
                showToast('Ошибка загрузки данных: ' + error.message, 'error');
            } finally {
                // Анимация появления элементов
                setTimeout(() => {
                    document.querySelectorAll('.metric-card, .venue-card').forEach((el, index) => {
                        setTimeout(() => el.classList.add('fade-in'), index * 50);
                    });
                }, 100);
            }
        }

        // Автообновление
        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                const businessDay = getCurrentBusinessDay();
                const todayStr = formatDateForInput(businessDay);
                
                if (currentStartDate === todayStr && currentEndDate === todayStr) {
                    console.log('Автообновление данных...');
                    delete dataCache[todayStr];
                    load(currentStartDate, currentEndDate);
                }
            }, AUTO_REFRESH_INTERVAL);
        }

        // Экспорт
        function exportPDF(filter = 'all') {
            const data = dataCache.current;
            if (!data) {
                showToast('Нет данных для экспорта', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Заголовок
            doc.setFontSize(16);
            doc.text('Чи-Фань - Отчет по выручке', 20, 20);
            
            doc.setFontSize(10);
            doc.text(`Период: ${data.date}`, 20, 30);
            doc.text(`Время обновления: ${data.time}`, 20, 35);
            
            let y = 45;
            
            // Метрики
            doc.setFontSize(12);
            doc.text('Основные метрики:', 20, y);
            y += 10;
            
            const total = data.total || {};
            doc.text(`Выручка: ${fmt.format(total.total_revenue || 0)} ₽`, 20, y);
            y += 7;
            doc.text(`Заказы: ${total.total_orders || 0}`, 20, y);
            y += 7;
            doc.text(`Доставка: ${total.total_delivery_orders || 0}`, 20, y);
            y += 7;
            doc.text(`Самовывоз: ${total.total_pickup_orders || 0}`, 20, y);
            y += 7;
            doc.text(`Кафе: ${total.total_cafe_orders || 0}`, 20, y);
            y += 15;
            
            // Филиалы
            const venues = filter === 'year-round' ? data.year_round : 
                          filter === 'seasonal' ? data.seasonal : 
                          { ...data.year_round, ...data.seasonal };
            
            doc.setFontSize(12);
            doc.text('Филиалы:', 20, y);
            y += 10;
            
            const sortedVenues = Object.entries(venues || {})
                .sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            
            sortedVenues.forEach(([venue, stats]) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(10);
                doc.text(`${venue}: ${fmt.format(stats.total_revenue || 0)} ₽ (${stats.total_orders || 0} заказов)`, 20, y);
                y += 7;
            });
            
            doc.save(`chifan_report_${currentStartDate}_${filter}.pdf`);
            showToast('PDF успешно экспортирован');
        }

        // Инициализация
        function init() {
            // Установка темы
            if (localStorage.getItem('theme') === 'dark') {
                toggleTheme();
            }
            
            // Установка дат по умолчанию
            const todayStr = getTodayDateString();
            document.getElementById('start-date').value = todayStr;
            document.getElementById('end-date').value = todayStr;
            
            // Активная кнопка "Сегодня"
            document.querySelector('.period-btn').classList.add('active');
            
            // Обновление информации о бизнес-дне
            updateBusinessDayInfo();
            
            // Загрузка данных
            load(todayStr, todayStr);
            
            // Запуск автообновления
            setupAutoRefresh();
        }

        function updateBusinessDayInfo() {
            const businessDayDate = getTodayDateString();
            document.getElementById('business-day-date').textContent = businessDayDate;
        }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
