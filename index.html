
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чи-Фань — Аналитика выручки</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #e2e8f0; /* Более серый светлый фон */
            transition: background-color 0.3s ease;
        }
        body.theme-dark {
            background-color: #0f172a; /* Темный фон */
        }
        .card {
            background-color: #ffffff; /* Светлые карточки */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.theme-dark .card {
            background-color: #1e293b; /* Темные карточки */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--tblr-primary);
            animation: fadeInValue 1s ease;
        }
        @keyframes fadeInValue {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .metric-label {
            font-size: 0.875rem;
            color: var(--tblr-muted);
        }
        .metric-breakdown {
            font-size: 0.75rem;
            color: var(--tblr-body-color);
        }
        .orders-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .order-type {
            text-align: center;
            padding: 5px 10px;
            border-radius: 4px;
            transition: transform 0.2s ease;
        }
        .order-type:hover {
            transform: scale(1.05);
        }
        .order-type.delivery { background-color: rgba(16, 185, 129, 0.1); color: #10b981; }
        .order-type.pickup { background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .order-type.cafe { background-color: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .status-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .chart-container {
            height: 300px !important; /* Fixed height for alignment */
            animation: fadeIn 0.5s ease;
        }
        .venue-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .venue-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .row-cards .card {
            min-height: 180px; /* Выравнивание высоты */
        }
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .sales-table th, .sales-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-3 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                <i class="ti ti-chart-line me-2"></i> Чи-Фань — Аналитика выручки
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <button class="btn btn-ghost-secondary" onclick="toggleTheme()">
                                <i class="ti ti-moon"></i> Тема
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-body">
                <div class="container-xl">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="ti ti-clock me-2 text-muted"></i>
                                        <span id="last-update">Загрузка данных...</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-calendar me-2 text-muted"></i>
                                        <span id="business-day-info">Бизнес-день: <span id="business-day-date"></span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">С:</span>
                                        <input type="date" class="form-control" id="start-date">
                                        <span class="input-group-text">По:</span>
                                        <input type="date" class="form-control" id="end-date">
                                        <button class="btn btn-primary" onclick="loadCustomData()">
                                            <i class="ti ti-download me-2"></i> Загрузить
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-list">
                                        <button class="btn" onclick="setPeriod('today', event)">Сегодня</button>
                                        <button class="btn" onclick="setPeriod('yesterday', event)">Вчера</button>
                                        <button class="btn" onclick="setPeriod('thisWeek', event)">Неделя</button>
                                        <button class="btn" onclick="setPeriod('thisMonth', event)">Месяц</button>
                                        <button class="btn" onclick="setPeriod('lastMonth', event)">Прошлый месяц</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" role="tab">Дашборд</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-analytics" role="tab">Аналитика</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sales" role="tab">Полуфабрикаты</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane active show" id="tab-dashboard" role="tabpanel" role="tabpanel">
                            <div class="row row-cards mb-3" id="metrics"></div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-chart-line me-2"></i> Прогресс по плану</h3>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Факт: <span id="current-value">0 ₽</span></span>
                                        <span>План: <span id="plan-value">0 ₽</span></span>
                                    </div>
                                    <div class="progress progress-sm mb-2">
                                        <div id="plan-bar" class="progress-bar" style="width: 0%"></div>
                                    </div>
                                    <div id="progress-text" class="text-center">0%</div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-building me-2"></i> Круглогодичные филиалы</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row row-cards" id="year-round"></div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-leaf me-2"></i> Сезонные филиалы</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row row-cards" id="seasonal"></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-analytics" role="tabpanel">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-chart-line me-2"></i> Выручка по времени</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="timeChart" class="chart-container"></canvas>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title"><i class="ti ti-chart-pie me-2"></i> Распределение выручки</h3>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="revenueChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title"><i class="ti ti-chart-bar me-2"></i> Выручка по филиалам</h3>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="venueChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-sales" role="tabpanel">
                            <div class="row row-cards" id="sales-data"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const fmt = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const YEAR_ROUND_VENUES = ['Красота', 'Луговая', 'Парк', 'Светланская', 'Чуркин', 'Тихая', 'Тобольская'];
        const SEASONAL_VENUES = ['Юбилейный', 'Кунгас', 'МГУ', 'Патрокл'];
        const AUTO_REFRESH_INTERVAL = 60000;
        let autoRefreshInterval;
        let lastDataHash = null;
        let timeChart = null;
        let revenueChart = null;
        let venueChart = null;
        let dataCache = {};
        let currentStartDate = null;
        let currentEndDate = null;
        let businessDayShift = false;

        function getCurrentBusinessDay() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            if (hours < 3 || (hours === 3 && minutes < 30)) {
                now.setDate(now.getDate() - 1);
                businessDayShift = true;
            } else {
                businessDayShift = false;
            }
            return now;
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            localStorage.setItem('theme', document.body.classList.contains('theme-dark') ? 'dark' : 'light');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} text-white`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function celebrate() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('HTTP error');
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                }
            }
        }

        function aggregateData(dailyData) {
            const aggregated = { year_round: {}, seasonal: {}, total: {}, sales: {}, plan: dailyData[0].plan || {} };
            [...YEAR_ROUND_VENUES, ...SEASONAL_VENUES].forEach(venue => {
                aggregated.sales[venue] = {};
            });
            dailyData.forEach(dayData => {
                ['year_round', 'seasonal'].forEach(type => {
                    Object.entries(dayData[type] || {}).forEach(([venue, stats]) => {
                        if (!aggregated[type][venue]) aggregated[type][venue] = {};
                        Object.entries(stats).forEach(([key, value]) => {
                            aggregated[type][venue][key] = (aggregated[type][venue][key] || 0) + value;
                        });
                    });
                });
                Object.entries(dayData.total || {}).forEach(([key, value]) => {
                    aggregated.total[key] = (aggregated.total[key] || 0) + value;
                });
                Object.entries(dayData.sales || {}).forEach(([venue, salesStats]) => {
                    Object.entries(salesStats).forEach(([cat, value]) => {
                        if (typeof value === 'object') {
                            if (!aggregated.sales[venue][cat]) aggregated.sales[venue][cat] = {};
                            Object.entries(value).forEach(([subItem, subValue]) => {
                                aggregated.sales[venue][cat][subItem] = (aggregated.sales[venue][cat][subItem] || 0) + subValue;
                            });
                        } else {
                            aggregated.sales[venue][cat] = (aggregated.sales[venue][cat] || 0) + value;
                        }
                    });
                });
            });
            aggregated.time = dailyData[dailyData.length - 1].time || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            return aggregated;
        }

        async function loadData(startDate, endDate) {
            const dates = [];
            let current = new Date(startDate);
            while (current <= new Date(endDate)) {
                dates.push(formatDateForInput(current));
                current.setDate(current.getDate() + 1);
            }
            const dailyData = [];
            for (const date of dates) {
                if (dataCache[date]) {
                    dailyData.push(dataCache[date]);
                    continue;
                }
                try {
                    const data = await fetchWithRetry(`${date}_data.json`);
                    dataCache[date] = data;
                    dailyData.push(data);
                } catch (error) {
                    console.warn(`Нет данных за ${date}: ${error.message}`);
                }
            }
            if (dailyData.length === 0) return null;
            const aggregatedData = aggregateData(dailyData);
            return { aggregatedData, dailyData };
        }

        function computeTotals(data) {
            data.total = {
                total_orders: 0,
                total_revenue: 0,
                total_delivery_orders: 0,
                total_delivery_revenue: 0,
                total_pickup_orders: 0,
                total_pickup_revenue: 0,
                total_cafe_orders: 0,
                total_cafe_revenue: 0
            };
            ['year_round', 'seasonal'].forEach(type => {
                Object.values(data[type] || {}).forEach(stats => {
                    Object.entries(stats).forEach(([key, value]) => {
                        data.total[key] += value;
                    });
                });
            });
            return data;
        }

        function isVenueActive(stats, salesStats) {
            return stats.total_revenue > 0 || Object.values(salesStats || {}).some(v => typeof v === 'number' ? v > 0 : Object.values(v).some(subV => subV > 0));
        }

        function isSalesActive(salesStats) {
            return Object.values(salesStats).some(v => typeof v === 'number' ? v > 0 : Object.values(v).some(subV => subV > 0));
        }

        function renderMetrics(data) {
            const total = data.total || {};
            let html = `
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="metric-label">Выручка</div>
                            <div class="metric-value">${fmt.format(total.total_revenue || 0)} ₽</div>
                            <div class="metric-breakdown">Доставка: ${fmt.format(total.total_delivery_revenue || 0)} ₽</div>
                            <div class="metric-breakdown">Самовывоз: ${fmt.format(total.total_pickup_revenue || 0)} ₽</div>
                            <div class="metric-breakdown">Кафе: ${fmt.format(total.total_cafe_revenue || 0)} ₽</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="metric-label">Заказы</div>
                            <div class="metric-value">${total.total_orders || 0}</div>
                            <div class="orders-breakdown">
                                <div class="order-type delivery">Доставка: ${total.total_delivery_orders || 0}</div>
                                <div class="order-type pickup">Самовывоз: ${total.total_pickup_orders || 0}</div>
                                <div class="order-type cafe">Кафе: ${total.total_cafe_orders || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="metric-label">Средний чек</div>
                            <div class="metric-value">${total.total_orders > 0 ? fmt.format(Math.round(total.total_revenue / total.total_orders)) : 0} ₽</div>
                            <div class="metric-breakdown">Доставка: ${total.total_delivery_orders > 0 ? fmt.format(Math.round(total.total_delivery_revenue / total.total_delivery_orders)) : 0} ₽</div>
                            <div class="metric-breakdown">Самовывоз: ${total.total_pickup_orders > 0 ? fmt.format(Math.round(total.total_pickup_revenue / total.total_pickup_orders)) : 0} ₽</div>
                            <div class="metric-breakdown">Кафе: ${total.total_cafe_orders > 0 ? fmt.format(Math.round(total.total_cafe_revenue / total.total_cafe_orders)) : 0} ₽</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('metrics').innerHTML = html;

            const plan = data.plan || {};
            const currentValue = total.total_revenue || 0;
            const planValue = plan.revenue || 0;
            const progress = planValue > 0 ? (currentValue / planValue) * 100 : 0;
            document.getElementById('current-value').textContent = fmt.format(currentValue) + ' ₽';
            document.getElementById('plan-value').textContent = fmt.format(planValue) + ' ₽';
            document.getElementById('plan-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;
            if (progress >= 100) celebrate();
        }

        function renderVenues(data, type) {
            const venues = type === 'year-round' ? YEAR_ROUND_VENUES : SEASONAL_VENUES;
            const venueData = data[type === 'year-round' ? 'year_round' : 'seasonal'] || {};
            let html = '';
            venues.forEach(venue => {
                const stats = venueData[venue] || {};
                const salesStats = data.sales[venue] || {};
                if (!isVenueActive(stats, salesStats)) return;
                html += `
                    <div class="col-md-4">
                        <div class="card venue-card">
                            <div class="card-header">
                                <h3 class="card-title">${venue}</h3>
                                <span class="status-badge bg-${stats.total_revenue > 0 ? 'success' : 'danger'}">${stats.total_revenue > 0 ? 'Активен' : 'Неактивен'}</span>
                            </div>
                            <div class="card-body">
                                <div class="venue-metrics">
                                    <div>
                                        <div class="metric-label">Выручка</div>
                                        <div class="metric-value">${fmt.format(stats.total_revenue || 0)} ₽</div>
                                    </div>
                                    <div>
                                        <div class="metric-label">Заказы</div>
                                        <div class="metric-value">${stats.total_orders || 0}</div>
                                    </div>
                                    <div>
                                        <div class="metric-label">Доставка</div>
                                        <div class="metric-value">${stats.delivery_orders || 0} (${fmt.format(stats.delivery_revenue || 0)} ₽)</div>
                                    </div>
                                    <div>
                                        <div class="metric-label">Самовывоз</div>
                                        <div class="metric-value">${stats.pickup_orders || 0} (${fmt.format(stats.pickup_revenue || 0)} ₽)</div>
                                    </div>
                                    <div>
                                        <div class="metric-label">Кафе</div>
                                        <div class="metric-value">${stats.cafe_orders || 0} (${fmt.format(stats.cafe_revenue || 0)} ₽)</div>
                                    </div>
                                    <div>
                                        <div class="metric-label">Средний чек</div>
                                        <div class="metric-value">${stats.total_orders > 0 ? fmt.format(Math.round(stats.total_revenue / stats.total_orders)) : 0} ₽</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById(type).innerHTML = html;
        }

        function renderSalesData(data) {
            let html = '';
            const allVenues = [...YEAR_ROUND_VENUES, ...SEASONAL_VENUES];
            allVenues.forEach(venue => {
                const salesStats = data.sales[venue] || {};
                if (!isSalesActive(salesStats)) return;
                html += `
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">${venue}</h3>
                            </div>
                            <div class="card-body">
                                <table class="sales-table">
                                    <thead>
                                        <tr>
                                            <th>Категория</th>
                                            <th>Количество</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                const categories = ['Лапша', 'Рис', 'Курица', 'Свинина', 'Креветка', 'Бекон', 'Соломка', 'Кубик'];
                categories.forEach(cat => {
                    const value = salesStats[cat] || 0;
                    if (value > 0) {
                        html += `
                            <tr>
                                <td>${cat}</td>
                                <td>${value.toFixed(cat === 'Соломка' || cat === 'Кубик' ? 2 : 0)}</td>
                            </tr>
                        `;
                    }
                });
                const saladSup = salesStats['Салаты - Супы'] || {};
                if (Object.values(saladSup).some(v => v > 0)) {
                    html += `
                        <tr>
                            <td colspan="2" class="metric-breakdown">Салаты - Супы:</td>
                        </tr>
                    `;
                    Object.entries(saladSup).forEach(([item, value]) => {
                        if (value > 0) {
                            html += `
                                <tr>
                                    <td>${item}</td>
                                    <td>${value}</td>
                                </tr>
                            `;
                        }
                    });
                }
                const pelmeniBao = salesStats['Пельмени - Бао-банс'] || {};
                if (Object.values(pelmeniBao).some(v => v > 0)) {
                    html += `
                        <tr>
                            <td colspan="2" class="metric-breakdown">Пельмени - Бао-банс:</td>
                        </tr>
                    `;
                    Object.entries(pelmeniBao).forEach(([item, value]) => {
                        if (value > 0) {
                            html += `
                                <tr>
                                    <td>${item}</td>
                                    <td>${value}</td>
                                </tr>
                            `;
                        }
                    });
                }
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('sales-data').innerHTML = html;
        }

        async function renderTimeChart(startDate, endDate, dailyData) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            if (timeChart) timeChart.destroy();
            const labels = dailyData.map(d => d.date);
            const revenues = dailyData.map(d => d.total.total_revenue || 0);
            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Выручка',
                        data: revenues,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderCharts(data) {
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(revenueCtx, {
                type: 'pie',
                data: {
                    labels: ['Доставка', 'Самовывоз', 'Кафе'],
                    datasets: [{
                        data: [data.total.total_delivery_revenue, data.total.total_pickup_revenue, data.total.total_cafe_revenue],
                        backgroundColor: ['#10b981', '#f59e0b', '#8b5cf6']
                    }]
                },
                options: { responsive: true }
            });

            const venueCtx = document.getElementById('venueChart').getContext('2d');
            if (venueChart) venueChart.destroy();
            const venueLabels = [];
            const venueRevenues = [];
            [...YEAR_ROUND_VENUES, ...SEASONAL_VENUES].forEach(venue => {
                const stats = data.year_round[venue] || data.seasonal[venue] || {};
                if (stats.total_revenue > 0) {
                    venueLabels.push(venue);
                    venueRevenues.push(stats.total_revenue);
                }
            });
            venueChart = new Chart(venueCtx, {
                type: 'bar',
                data: {
                    labels: venueLabels,
                    datasets: [{
                        label: 'Выручка',
                        data: venueRevenues,
                        backgroundColor: 'rgb(54, 162, 235)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function setPeriod(period, event) {
            document.querySelectorAll('.btn-list .btn').forEach(btn => btn.classList.remove('btn-primary'));
            event.target.classList.add('btn-primary');
            const today = getCurrentBusinessDay();
            let start, end;
            switch (period) {
                case 'today':
                    start = end = today;
                    break;
                case 'yesterday':
                    start = end = new Date(today);
                    start.setDate(start.getDate() - 1);
                    break;
                case 'thisWeek':
                    start = new Date(today);
                    start.setDate(start.getDate() - start.getDay() + 1);
                    end = today;
                    break;
                case 'thisMonth':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = today;
                    break;
                case 'lastMonth':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }
            document.getElementById('start-date').value = formatDateForInput(start);
            document.getElementById('end-date').value = formatDateForInput(end);
            loadCustomData();
        }

        function loadCustomData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) {
                showToast('Выберите даты', 'error');
                return;
            }
            load(startDate, endDate);
        }

        async function load(startDateStr, endDateStr) {
            currentStartDate = startDateStr;
            currentEndDate = endDateStr;
            const updateEl = document.getElementById('last-update');
            updateEl.innerHTML = '<i class="ti ti-refresh"></i> Обновление...';
            if (startDateStr === endDateStr) {
                const todayStr = formatDateForInput(getCurrentBusinessDay());
                if (startDateStr === todayStr) {
                    try {
                        let data = await fetchWithRetry('revenue.json');
                        data = computeTotals(data);
                        dataCache.current = data;
                        const currentDataHash = JSON.stringify(data.total);
                        if (lastDataHash && lastDataHash !== currentDataHash) {
                            showToast('Обновлены данные', 'success');
                        }
                        lastDataHash = currentDataHash;
                        let dateDisplay = data.date;
                        if (updateEl) {
                            updateEl.innerHTML = `<i class="ti ti-check"></i> Обновлено: ${data.time} (${dateDisplay})`;
                        }
                        renderMetrics(data);
                        renderVenues(data, 'year-round');
                        renderVenues(data, 'seasonal');
                        renderSalesData(data);
                        renderCharts(data);
                        await renderTimeChart(currentStartDate, currentEndDate, [data]);
                        return;
                    } catch (e) {
                        console.warn(`Нет данных за сегодня в revenue.json: ${e.message}`);
                    }
                }
            }
            try {
                const result = await loadData(startDateStr, endDateStr);
                if (!result) {
                    throw new Error('Данные не получены');
                }
                let { aggregatedData, dailyData } = result;
                aggregatedData = computeTotals(aggregatedData);
                dataCache.current = aggregatedData;
                const currentDataHash = JSON.stringify(aggregatedData.total);
                if (lastDataHash && lastDataHash !== currentDataHash) {
                    showToast('Обновлены данные', 'success');
                }
                lastDataHash = currentDataHash;
                let dateDisplay = startDateStr === endDateStr ?
                    new Date(startDateStr).toLocaleDateString('ru-RU') :
                    `${new Date(startDateStr).toLocaleDateString('ru-RU')} - ${new Date(endDateStr).toLocaleDateString('ru-RU')}`;
                if (updateEl) {
                    updateEl.innerHTML = `<i class="ti ti-check"></i> Обновлено: ${aggregatedData.time} (${dateDisplay})`;
                }
                renderMetrics(aggregatedData);
                renderVenues(aggregatedData, 'year-round');
                renderVenues(aggregatedData, 'seasonal');
                renderSalesData(aggregatedData);
                renderCharts(aggregatedData);
                await renderTimeChart(currentStartDate, currentEndDate, dailyData);
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                if (updateEl) {
                    updateEl.innerHTML = '<i class="ti ti-alert-triangle"></i> Ошибка загрузки';
                }
                document.getElementById('metrics').innerHTML = '<div class="alert alert-danger">Ошибка загрузки метрик: ' + error.message + '</div>';
                document.getElementById('year-round').innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных по круглогодичным филиалам</div>';
                document.getElementById('seasonal').innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных по сезонным филиалам</div>';
                document.getElementById('sales-data').innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных по полуфабрикатам</div>';
                showToast('Ошибка загрузки данных: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    document.querySelectorAll('.card').forEach((el, index) => {
                        setTimeout(() => el.classList.add('fade-in'), index * 50);
                    });
                }, 100);
            }
        }

        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(() => {
                const businessDay = getCurrentBusinessDay();
                const todayStr = formatDateForInput(businessDay);
                if (currentStartDate === todayStr && currentEndDate === todayStr) {
                    console.log('Автообновление данных...');
                    delete dataCache[todayStr];
                    load(currentStartDate, currentEndDate);
                }
            }, AUTO_REFRESH_INTERVAL);
        }

        function exportPDF(filter = 'all') {
            const data = dataCache.current;
            if (!data) {
                showToast('Нет данных для экспорта', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Чи-Фань - Отчет по выручке', 20, 20);
            doc.setFontSize(10);
            doc.text(`Период: ${currentStartDate} - ${currentEndDate}`, 20, 30);
            doc.text(`Время обновления: ${data.time}`, 20, 35);
            let y = 45;

            if (filter === 'all' || filter === 'year-round' || filter === 'seasonal') {
                doc.setFontSize(12);
                doc.text('Основные метрики:', 20, y);
                y += 10;

                const total = data.total || {};
                if (total.total_revenue > 0) doc.text(`Выручка: ${fmt.format(total.total_revenue || 0)} ₽`, 20, y); y += 7;
                if (total.total_orders > 0) doc.text(`Заказы: ${total.total_orders || 0}`, 20, y); y += 7;
                if (total.total_delivery_orders > 0) doc.text(`Доставка: ${total.total_delivery_orders || 0}`, 20, y); y += 7;
                if (total.total_pickup_orders > 0) doc.text(`Самовывоз: ${total.total_pickup_orders || 0}`, 20, y); y += 7;
                if (total.total_cafe_orders > 0) doc.text(`Кафе: ${total.total_cafe_orders || 0}`, 20, y); y += 15;

                const venues = filter === 'year-round' ? data.year_round : 
                              filter === 'seasonal' ? data.seasonal : 
                              { ...data.year_round, ...data.seasonal };
                doc.setFontSize(12);
                doc.text('Филиалы:', 20, y);
                y += 10;

                const sortedVenues = Object.entries(venues || {})
                    .filter(([venue, stats]) => isVenueActive(stats, data.sales[venue]))
                    .sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));

                sortedVenues.forEach(([venue, stats]) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setFontSize(10);
                    doc.text(`${venue}: ${fmt.format(stats.total_revenue || 0)} ₽ (${stats.total_orders || 0} заказов)`, 20, y);
                    y += 7;
                    if (stats.delivery_orders > 0) {
                        doc.text(`Доставка: ${stats.delivery_orders} (${fmt.format(stats.delivery_revenue || 0)} ₽)`, 25, y);
                        y += 7;
                    }
                    if (stats.pickup_orders > 0) {
                        doc.text(`Самовывоз: ${stats.pickup_orders} (${fmt.format(stats.pickup_revenue || 0)} ₽)`, 25, y);
                        y += 7;
                    }
                    if (stats.cafe_orders > 0) {
                        doc.text(`Кафе: ${stats.cafe_orders} (${fmt.format(stats.cafe_revenue || 0)} ₽)`, 25, y);
                        y += 7;
                    }
                });
            }

            if (filter === 'all' || filter === 'sales') {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(12);
                doc.text('Полуфабрикаты:', 20, y);
                y += 10;

                const allVenues = [...YEAR_ROUND_VENUES, ...SEASONAL_VENUES];
                allVenues.forEach(venue => {
                    const salesStats = data.sales[venue] || {};
                    if (isSalesActive(salesStats)) {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.setFontSize(10);
                        doc.text(`${venue}:`, 20, y);
                        y += 7;
                        const categories = ['Лапша', 'Рис', 'Курица', 'Свинина', 'Креветка', 'Бекон', 'Соломка', 'Кубик'];
                        categories.forEach(cat => {
                            const value = salesStats[cat] || 0;
                            if (value > 0) {
                                doc.text(`${cat}: ${value.toFixed(cat === 'Соломка' || cat === 'Кубик' ? 2 : 0)}`, 25, y);
                                y += 7;
                            }
                        });
                        const saladSup = salesStats['Салаты - Супы'] || {};
                        if (Object.values(saladSup).some(v => v > 0)) {
                            doc.text('Салаты - Супы:', 25, y);
                            y += 7;
                            Object.entries(saladSup).forEach(([item, value]) => {
                                if (value > 0) {
                                    doc.text(`${item}: ${value}`, 30, y);
                                    y += 7;
                                }
                            });
                        }
                        const pelmeniBao = salesStats['Пельмени - Бао-банс'] || {};
                        if (Object.values(pelmeniBao).some(v => v > 0)) {
                            doc.text('Пельмени - Бао-банс:', 25, y);
                            y += 7;
                            Object.entries(pelmeniBao).forEach(([item, value]) => {
                                if (value > 0) {
                                    doc.text(`${item}: ${value}`, 30, y);
                                    y += 7;
                                }
                            });
                        }
                        y += 5;
                    }
                });
            }

            doc.save(`chifan_report_${currentStartDate}_${filter}.pdf`);
            showToast('PDF успешно экспортирован');
        }

        // Инициализация
        function init() {
            // Установка темы
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('theme-dark');
            }
            
            // Установка дат по умолчанию
            const businessDay = getCurrentBusinessDay();
            const businessDayStr = formatDateForInput(businessDay);
            document.getElementById('start-date').value = businessDayStr;
            document.getElementById('end-date').value = businessDayStr;
            
            // Активная кнопка "Сегодня"
            document.querySelector('.btn-list .btn').classList.add('btn-primary');
            
            // Обновление информации о бизнес-дне
            updateBusinessDayInfo();
            
            // Загрузка данных
            load(businessDayStr, businessDayStr);
            
            // Запуск автообновления
            setupAutoRefresh();
        }

        function updateBusinessDayInfo() {
            const businessDay = getCurrentBusinessDay();
            const businessDayDate = formatDateForInput(businessDay);
            document.getElementById('business-day-date').textContent = businessDayDate;
        }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
